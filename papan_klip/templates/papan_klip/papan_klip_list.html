{% extends 'core/base.html' %}
{% load static %}
{% block title %}Papan Klip{% endblock %}

{% block content %}


<div class="form-container">
    <h1 class="page-header">Papan Klip</h1>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end align-items-center mb-4">
                    <a href="{% url 'papan_klip:papan_klip_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Create New Entry
                    </a>
                </div>

                <div class="card shadow-sm mb-4">
                    <div
                        class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="input-group input-group-sm me-2" style="min-width: 250px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="globalSearch" class="form-control"
                                placeholder="Search in all columns...">
                            <button id="clearSearch" class="btn btn-outline-secondary" type="button"
                                title="Clear search" style="border-color: #dee2e6;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0 d-flex flex-column" style="height: calc(100vh - 200px);">
                        <div style="flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
                            <div id="tabulator-table" class="loading"
                                style="flex: 1; min-height: 0; min-width: 100%; position: relative;">
                                <div class="loader-container"
                                    style='position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;'>
                                    <div class="loader"
                                        style='display:inline-block; border:4px solid #0d6efd; border-radius:10px; background:#fff; font-weight:bold; font-size:16px; color:#0d6efd; padding:12px 24px; border-width: 2px; box-shadow: 0 2px 4px rgba(0, 109, 237, 0.2);'>
                                        Loading Data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this entry? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
<template id="action-buttons-template">
    <div class="d-flex gap-2">
        <a href="#" class="btn btn-sm btn-warning action-edit" data-bs-toggle="tooltip" title="Edit">
            <i class="fas fa-edit"></i>
        </a>
        <span data-bs-toggle="tooltip" data-bs-placement="top" title="Delete">
            <button type="button" class="btn btn-sm btn-danger action-delete" data-bs-toggle="modal"
                data-bs-target="#deleteConfirmationModal">
                <i class="fas fa-trash"></i>
            </button>
        </span>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            if (typeof bootstrap !== 'undefined') {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });

        // Add event listeners for global search
        var searchInput = document.getElementById('globalSearch');
        var clearSearchBtn = document.getElementById('clearSearch');
        var searchTimeout;

        // Search on input with debounce
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                var searchValue = searchInput.value;
                if (searchValue === '') {
                    table.clearFilter();
                } else {
                    table.setFilter(function (data) {
                        return table.options.globalSearch(data, searchValue);
                    });
                }
            }, 300);
        });

        // Clear search
        clearSearchBtn.addEventListener('click', function () {
            searchInput.value = '';
            table.clearFilter();
        });

        // Search on Enter key
        searchInput.addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                var searchValue = searchInput.value;
                if (searchValue === '') {
                    table.clearFilter();
                } else {
                    table.setFilter(function (data) {
                        return table.options.globalSearch(data, searchValue);
                    });
                }
            }
        });

        // Test the API endpoint first
        console.log('Testing API endpoint...');
        var apiUrl = "{% url 'papan_klip:papan_klip_list_api' %}";

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
            .then(function (response) {
                console.log('API Response Status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(function (apiData) {
                console.log('API Data:', apiData);

                // Initialize Tabulator with the data we just fetched
                console.log('Initializing Tabulator with data...');
                var table = new Tabulator("#tabulator-table", {
                    data: apiData, // Load data directly
                    layout: "fitColumns",
                    responsiveLayout: "hide",
                    pagination: "local",
                    paginationSize: 20,
                    paginationSizeSelector: [10, 20, 50, 100],
                    columns: [
                        {
                            title: "Title",
                            field: "title",
                            headerHozAlign: "left",
                            hozAlign: "left",
                            width: 400,
                        },
                        {
                            title: "Created At",
                            field: "created_at",
                            headerHozAlign: "center",
                            hozAlign: "center",
                            width: 150,
                            formatter: function (cell) {
                                var date = new Date(cell.getValue());
                                var year = date.getFullYear();
                                var month = String(date.getMonth() + 1).padStart(2, '0');
                                var day = String(date.getDate()).padStart(2, '0');
                                return `${year}-${month}-${day}`;
                            }
                        },
                        {
                            title: "Expires In",
                            field: "expires_at",
                            headerHozAlign: "center",
                            hozAlign: "center",
                            width: 150,
                            formatter: function (cell) {
                                var expiresAt = new Date(cell.getValue());
                                var now = new Date();
                                var diffMs = expiresAt - now;
                                var diffHrs = Math.floor((diffMs % 86400000) / 3600000);
                                var diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000);

                                if (diffMs < 0) {
                                    return '<span class="badge bg-danger">Expired</span>';
                                } else if (diffMs < 3600000) {
                                    return '<span class="badge bg-warning">' + diffMins + 'm</span>';
                                } else {
                                    return '<span class="badge bg-success">' + diffHrs + 'h ' + diffMins + 'm</span>';
                                }
                            }
                        },
                        {
                            title: "Actions",
                            headerHozAlign: "center",
                            formatter: function (cell, formatterParams, onRendered) {
                                const row = cell.getRow();
                                const data = row.getData();
                                const id = data.id;

                                // Get the template and clone it
                                const template = document.getElementById('action-buttons-template');
                                const clone = template.content.cloneNode(true);
                                const container = clone.querySelector('.d-flex');

                                // Set up the buttons
                                const editBtn = container.querySelector('.action-edit');
                                const deleteBtn = container.querySelector('.action-delete');

                                // Set URLs
                                editBtn.href = '{% url "papan_klip:papan_klip_update" 0 %}'.replace('0', id);
                                deleteBtn.dataset.deleteUrl = '{% url "papan_klip:papan_klip_delete" 0 %}'.replace('0', id);

                                // Initialize tooltips
                                const tooltipTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
                                tooltipTriggerList.map(function (tooltipTriggerEl) {
                                    return new bootstrap.Tooltip(tooltipTriggerEl);
                                });

                                // Return the cloned node
                                return container;
                            },
                            headerSort: false
                        }
                    ],
                });

                // Store table reference for later use
                window.papanKlipTable = table;

                // Initialize tooltips again after table is rendered
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    if (typeof bootstrap !== 'undefined') {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    }
                });

                console.log('Tabulator initialized successfully');
            })
            .catch(function (error) {
                console.error('Error fetching data:', error);
                document.querySelector('#tabulator-table').innerHTML = [
                    '<div class="alert alert-danger">',
                    '    <i class="fas fa-exclamation-triangle me-2"></i>',
                    '    Error loading data. Please try again later.',
                    '</div>'
                ].join('\n');
            });

        // Create a single form for all delete actions
        const deleteForm = document.createElement('form');
        deleteForm.method = 'post';
        deleteForm.style.display = 'none';
        deleteForm.innerHTML = '{% csrf_token %}';
        document.body.appendChild(deleteForm);

        let deleteUrl = '';

        // When delete button is clicked, store the delete URL
        document.addEventListener('click', function (e) {
            if (e.target.closest('.action-delete')) {
                e.preventDefault();
                const button = e.target.closest('.action-delete');
                deleteUrl = button.getAttribute('data-delete-url');
                console.log('Delete URL set to:', deleteUrl);
            }
        });

        // When confirm delete is clicked, submit the form
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                console.log('Delete button clicked, URL:', deleteUrl);
                if (deleteUrl) {
                    deleteForm.action = deleteUrl;
                    console.log('Submitting form to:', deleteUrl);
                    deleteForm.submit();
                } else {
                    console.error('No delete URL specified');
                }
            });
        } else {
            console.error('Confirm delete button not found');
        }
    });
</script>
{% endblock %}