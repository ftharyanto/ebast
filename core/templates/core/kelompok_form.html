{% extends 'core/base.html' %}
{% block content %}
<style>
    .container {
        margin: 2rem auto;
        padding: 2rem;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: bold;
        color: #333;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-actions {
        margin-top: 2rem;
        text-align: center;
    }

    .btn {
        margin-right: 0.5rem;
        padding: 0.5rem 1.5rem;
        font-size: 1rem;
    }

    .table {
        margin-top: 1.5rem;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table th, .table td {
        padding: 1rem;
        text-align: center;
        vertical-align: middle;
    }

    .table th {
        background-color: #f1f1f1;
        font-weight: bold;
    }

    .suggestions {
        border: 1px solid #ccc;
        border-top: none;
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        z-index: 1000;
        background: #fff;
        width: 100%;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .suggestion-item {
        padding: 8px;
        cursor: pointer;
    }

    .suggestion-item:hover {
        background-color: #f0f0f0;
    }

    .drag-handle {
        cursor: grab;
    }

    .drag-over {
        border-top: 2px solid rgb(0, 174, 255);
    }

    .hidden {
        display: none;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9f9f9;
    }

    .table-striped tbody tr:nth-of-type(even) {
        background-color: #ffffff;
    }
</style>

<div class="container">
    <h1 class="page-header">Create Kelompok Form</h1>
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        {% load form_tags %}

        {% if form.errors %}
        <div class="alert alert-danger">
            Please correct the errors below.
            <ul>
                {% for field in form %}
                {% if field.errors %}
                {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="form-group row">
            <div class="col-md-4">
                {{ form.name.label_tag }}
                {{ form.name|add_class:"form-control" }}
                <div class="invalid-feedback">
                    Please provide a valid name.
                </div>
            </div>
        </div>

        <div class="form-group row hidden">
            <div class="col-md-4">
                {{ form.member.label_tag }}
                {{ form.member|add_class:"form-control" }}
                <div class="invalid-feedback">
                    Please provide a valid member.
                </div>
            </div>
        </div>

        <div class="mb-3 position-relative">
            <label for="oprInput" class="form-label">Ketik nama operator:</label>
            <input type="text" id="oprInput" class="form-control" autocomplete="off" placeholder="Type to search...">
            <div id="suggestions" class="suggestions d-none"></div>
        </div>

        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th></th>
                    <th>No</th>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="oprTableBody">
                <!-- Rows will be dynamically added here -->
            </tbody>
        </table>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'core:kelompok_list' %}'">Cancel</button>
        </div>
    </form>
</div>



<script>
    const oprInput = document.getElementById('oprInput');
    const suggestionsBox = document.getElementById('suggestions');
    const oprTableBody = document.getElementById('oprTableBody');
    let oprCount = 0;
    let operators = [];

    // Fetch operators from the server once
    async function fetchOperators() {
        try {
            const response = await fetch('/core/api/get_operator_list/');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            operators = data.operators;
            return operators;
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    // Load operators when the page loads
    window.addEventListener('load', () => {
        fetchOperators().then((operators) => {
            // Assuming 'memberId' is an array of operator IDs
            const memberIds = document.getElementById('{{ form.member.id_for_label }}').value.split(',');
            memberIds.forEach(memberId => {
                const operator = operators.find(opr => opr.pk == memberId);
                if (operator) {
                    addOprToTable(operator.name);
                }
            });
        });
    });

    // Show suggestions as user types
    oprInput.addEventListener('input', () => {
        const query = oprInput.value.toLowerCase();
        suggestionsBox.innerHTML = '';
        if (query) {
            const matchedOpr = operators.filter(operator => operator.name.toLowerCase().includes(query));
            if (matchedOpr.length) {
                matchedOpr.forEach(operator => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = operator.name;
                    item.addEventListener('click', () => {
                        addOprToTable(operator.name);
                        oprInput.value = '';
                        suggestionsBox.classList.add('d-none');
                    });
                    suggestionsBox.appendChild(item);
                });
                suggestionsBox.classList.remove('d-none');
            } else {
                suggestionsBox.classList.add('d-none');
            }
        } else {
            suggestionsBox.classList.add('d-none');
        }
    });

    // Hide suggestions when input loses focus
    oprInput.addEventListener('blur', () => {
        setTimeout(() => suggestionsBox.classList.add('d-none'), 200);
    });

    // Add operator to the table
    function addOprToTable(operator) {
        oprCount++;
        const operatorData = operators.find(opr => opr.name === operator);

        // Create a new row
        const row = document.createElement('tr');
        row.setAttribute('draggable', 'true');
        row.innerHTML = `
        <td class="drag-handle">â˜°</td>
        <td>${oprCount}</td>
        <td>${operatorData.pk}</td>
        <td>${operatorData.name}</td>
        <td>
          <button class="btn btn-danger btn-sm delete"><i class="fas fa-trash"></i></button>
        </td>
      `;

        // Add delete functionality
        row.querySelector('.delete').addEventListener('click', () => {
            row.remove();
            updateRowNumbers();
            updateMemberInput();
        });

        // Append row to table
        oprTableBody.appendChild(row);
        updateMemberInput();
    }

    // Update row numbers after deletion
    function updateRowNumbers() {
        const rows = oprTableBody.querySelectorAll('tr');
        oprCount = 0;
        rows.forEach((row) => {
            oprCount++;
            row.children[1].textContent = oprCount;
        });
    }

    // Update member input with IDs in comma-separated format
    function updateMemberInput() {
        const rows = oprTableBody.querySelectorAll('tr');
        const ids = Array.from(rows).map(row => row.children[2].textContent);
        document.getElementById('{{ form.member.id_for_label }}').value = ids.join(',');
    }

    // Add drag-and-drop functionality
    oprTableBody.addEventListener('dragstart', (event) => {
        if (event.target.tagName === 'TR') {
            event.target.classList.add('dragging');
        }
    });

    oprTableBody.addEventListener('dragend', (event) => {
        if (event.target.tagName === 'TR') {
            event.target.classList.remove('dragging');
        }
    });

    oprTableBody.addEventListener('dragover', (event) => {
        event.preventDefault();
        const draggingRow = oprTableBody.querySelector('.dragging');
        const afterElement = getDragAfterElement(oprTableBody, event.clientY);

        // Remove existing drag-over indicators
        oprTableBody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));

        if (afterElement == null) {
            oprTableBody.appendChild(draggingRow);
        } else {
            oprTableBody.insertBefore(draggingRow, afterElement);
            afterElement.classList.add('drag-over');
        }
    });

    oprTableBody.addEventListener('dragleave', () => {
        oprTableBody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
    });

    oprTableBody.addEventListener('drop', () => {
        oprTableBody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
        updateRowNumbers();
        updateMemberInput();
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>
{% endblock %}