{% extends 'core/base.html' %}
{% load static %}
{% block title %}Kelompok List{% endblock %}

{% block content %}
<div class="form-container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8"> {# Adjust column size as needed #}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Kelompok List</h1>
                <a href="{% url 'core:kelompok_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Add Kelompok
                </a>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                    <div>
                        <label for="recordsPerPageTop" class="form-label me-2 mb-0 small">Show:</label>
                        <select id="recordsPerPageTop" class="form-select form-select-sm d-inline-block w-auto">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span class="ms-1 small">entries</span>
                    </div>
                    <div class="input-group input-group-sm w-auto">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="nameFilter" onkeyup="filterTable()" placeholder="Filter by Name"
                            class="form-control">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 table-layout-fixed table-center"
                            id="kelompokTable">
                            <thead class="table-light">
                                <tr>
                                    <th onclick="sortTable(0)" class="table-pointer table-col-50">Name <span
                                            id="nameSortArrow"></span></th>
                                    <th class="table-center table-col-50">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="kelompokTableBody">
                                {% for record in kelompok %}
                                <tr>
                                    <td class="table-center">{{ record.name }}</td>
                                    <td class="table-center">
                                        <a href="{% url 'core:kelompok_update' record.pk %}"
                                            class="btn btn-sm btn-warning me-1" data-bs-toggle="tooltip" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form action="{% url 'core:kelompok_delete_direct' record.pk %}" method="post"
                                            style="display:inline;" class="delete-form">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger delete-button"
                                                data-bs-toggle="tooltip" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">No kelompok found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light d-flex justify-content-between align-items-center py-2">
                    <div id="tableInfo" class="small text-muted"></div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"><button id="prevPage" class="page-link"><i
                                        class="fas fa-angle-left"></i></button></li>
                            <li class="page-item disabled"><span id="pageInfo" class="page-link"></span></li>
                            <li class="page-item"><button id="nextPage" class="page-link"><i
                                        class="fas fa-angle-right"></i></button></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize tooltips (assuming Bootstrap 5)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Delete confirmation
        const deleteForms = document.querySelectorAll('.delete-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                const confirmed = confirm('Are you sure you want to delete this item?');
                if (!confirmed) {
                    event.preventDefault(); // Stop form submission
                }
            });
        });

        // --- Pagination, Filtering, Sorting Logic ---
        let currentPage = 1;
        let recordsPerPage = parseInt(document.getElementById("recordsPerPageTop").value);
        const table = document.getElementById("kelompokTable");
        const tbody = document.getElementById("kelompokTableBody");
        const originalRows = Array.from(tbody.querySelectorAll("tr")); // Store original rows
        let currentRows = [...originalRows]; // Rows currently being displayed/filtered/sorted
        let totalPages = Math.ceil(currentRows.length / recordsPerPage);
        let sortDirection = { 0: 'asc' }; // Keep track of sort direction for each column

        const pageInfoSpan = document.getElementById("pageInfo");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const recordsPerPageSelect = document.getElementById("recordsPerPageTop");
        const nameFilterInput = document.getElementById("nameFilter");
        const tableInfoDiv = document.getElementById("tableInfo");

        function displayPage(page) {
            currentPage = page;
            const start = (page - 1) * recordsPerPage;
            const end = start + recordsPerPage;

            // Hide all rows first
            originalRows.forEach(row => row.style.display = 'none');

            // Show only rows for the current page from the *current* set (filtered/sorted)
            const pageRows = currentRows.slice(start, end);
            pageRows.forEach(row => row.style.display = '');

            // Update pagination controls
            pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageButton.parentElement.classList.toggle('disabled', currentPage === 1);
            nextPageButton.parentElement.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);

            // Update table info
            const startRecord = currentRows.length > 0 ? start + 1 : 0;
            const endRecord = Math.min(end, currentRows.length);
            tableInfoDiv.textContent = `Showing ${startRecord} to ${endRecord} of ${currentRows.length} entries`;

            // Ensure tbody is not empty if there are rows
            if (tbody.children.length === 0 && originalRows.length > 0) {
                originalRows.forEach(row => tbody.appendChild(row)); // Re-add if needed (shouldn't be necessary with display none/block)
            }

            // Handle empty table state
            handleEmptyTable();
        }

        function handleEmptyTable() {
            const emptyRow = tbody.querySelector('.empty-row');
            if (currentRows.length === 0 && !emptyRow) {
                const tr = document.createElement('tr');
                tr.classList.add('empty-row');
                tr.innerHTML = `<td colspan="2" class="text-center text-muted py-3">No matching records found.</td>`;
                tbody.appendChild(tr);
                pageInfoSpan.textContent = `Page 0 of 0`;
                tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                prevPageButton.parentElement.classList.add('disabled');
                nextPageButton.parentElement.classList.add('disabled');
            } else if (currentRows.length > 0 && emptyRow) {
                emptyRow.remove();
            } else if (originalRows.length === 0) {
                // Keep the initial empty message if the table was empty from the start
                pageInfoSpan.textContent = `Page 0 of 0`;
                tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                prevPageButton.parentElement.classList.add('disabled');
                nextPageButton.parentElement.classList.add('disabled');
            }
        }


        function updateRecordsPerPage() {
            recordsPerPage = parseInt(this.value);
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1; // Avoid division by zero issues if no rows
            currentPage = 1; // Reset to first page
            displayPage(currentPage);
        }

        function filterTable() {
            const filter = nameFilterInput.value.toLowerCase();
            currentRows = originalRows.filter(row => {
                const td = row.getElementsByTagName("td")[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    return txtValue.toLowerCase().includes(filter);
                }
                return false;
            });
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            currentPage = 1; // Reset to first page after filtering
            // Re-apply sort before displaying
            applySort();
            displayPage(currentPage);
        }

        function sortTable(n) {
            const currentDir = sortDirection[n] || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortDirection = { [n]: newDir }; // Store new direction for this column only

            applySort(); // Apply the sort based on currentRows and sortDirection
            currentPage = 1; // Reset to first page after sorting
            displayPage(currentPage);
            setArrow(n, newDir);
        }

        function applySort() {
            const columnIndex = Object.keys(sortDirection)[0]; // Assuming only one column sorted at a time
            if (columnIndex === undefined) return; // No sort applied yet

            const dir = sortDirection[columnIndex];
            const n = parseInt(columnIndex);

            currentRows.sort((a, b) => {
                // Ensure we get text content, even if there are nested elements (though unlikely here)
                const x = a.getElementsByTagName("TD")[n].textContent.toLowerCase();
                const y = b.getElementsByTagName("TD")[n].textContent.toLowerCase();
                if (dir === "asc") {
                    return x.localeCompare(y);
                } else {
                    return y.localeCompare(x);
                }
            });

            // Re-append sorted rows to tbody to ensure DOM order matches the sorted array
            // Clear existing rows first (except the potential empty row)
            const emptyRow = tbody.querySelector('.empty-row');
            tbody.innerHTML = ''; // Clear tbody content
            if (emptyRow) tbody.appendChild(emptyRow); // Re-add empty row if it existed

            currentRows.forEach(row => tbody.appendChild(row));
        }

        function resetArrows() {
            document.getElementById("nameSortArrow").innerHTML = "";
            // Add more arrows if needed: document.getElementById("codeSortArrow").innerHTML = "";
        }

        function setArrow(n, dir) {
            resetArrows(); // Clear previous arrows
            const arrow = dir === "asc" ? '<i class="fas fa-sort-up ms-1"></i>' : '<i class="fas fa-sort-down ms-1"></i>';
            if (n === 0) {
                document.getElementById("nameSortArrow").innerHTML = arrow;
            }
            // Add more columns if needed: else if (n == 1) { document.getElementById("codeSortArrow").innerHTML = arrow; }
        }

        // --- Event Listeners ---
        recordsPerPageSelect.addEventListener("change", updateRecordsPerPage);
        nameFilterInput.addEventListener("keyup", filterTable); // Changed from onkeyup attribute

        prevPageButton.addEventListener("click", function () {
            if (currentPage > 1) {
                displayPage(currentPage - 1);
            }
        });

        nextPageButton.addEventListener("click", function () {
            if (currentPage < totalPages) {
                displayPage(currentPage + 1);
            }
        });

        // --- Initial Setup ---
        // Assign sortTable to global scope IF using onclick attribute in HTML
        window.sortTable = sortTable;
        // Assign filterTable to global scope IF using onkeyup attribute in HTML
        window.filterTable = filterTable; // Assign filterTable to window if using onkeyup

        setArrow(0, 'asc'); // Set initial arrow if desired (sorting isn't applied until clicked)
        totalPages = Math.ceil(currentRows.length / recordsPerPage); // Recalculate initial totalPages
        if (totalPages === 0) totalPages = 1;
        displayPage(currentPage); // Initial display

    });
</script>
{% endblock %}