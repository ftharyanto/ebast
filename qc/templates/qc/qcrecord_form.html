{% extends 'core/base.html' %}
{% block content %}
    <div class="container">
        <h1 class="mt-5">QC Record Form</h1>
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            {% load form_tags %}

            {% if form.errors %}
            <div class="alert alert-danger">
                Please correct the errors below.
                <ul>
                    {% for field in form %}
                        {% if field.errors %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
            <div class="form-group row">
                <div class="col-md-4">
                    <label for="date_input">Date</label>
                    <input type="date" id="date_input" name="date_input" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="waktu_dinas">Waktu Dinas</label>
                    <select id="waktu_dinas" name="waktu_dinas" class="form-control">
                        <option value="P">P</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="col-md-4">
                    {{ form.qc_id.label_tag }}
                    {{ form.qc_id|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid QC ID.
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="form-group col-md-4">
                        {{ form.kelompok.label_tag }}
                        {{ form.kelompok|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please select a valid kelompok.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.jam_pelaksanaan.label_tag }}
                        {{ form.jam_pelaksanaan|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please fill a valid jam pelaksanaan.
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qc_prev_start">Start Date and Time (UTC)</label>
                        <input type="datetime-local" id="datetime_qc_prev_start" class="form-control"
                            value="2024-12-14 00:00:00">
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qc_prev_end">End Date and Time (UTC)</label>
                        <input type="datetime-local" id="datetime_qc_prev_end" class="form-control"
                            value="2024-12-14 07:00:00">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qc_prev" class="btn btn-primary align-bottom">Fetch
                            Data</button>
                    </div>
                </div>
                {{ form.qc_prev.label_tag }}
                {{ form.qc_prev|add_class:"form-control" }}
                <div class="form-group row">
                    <div class="col-md-6">
                        {{ form.event_indonesia.label_tag }}
                        {{ form.event_indonesia|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        {{ form.event_luar.label_tag }}
                        {{ form.event_luar|add_class:"form-control" }}
                    </div>
                </div>
                <div class="invalid-feedback">
                    Please provide a valid previous QC.
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qc_start">Start Date and Time (UTC)</label>
                        <input type="datetime-local" id="datetime_qc_start" class="form-control"
                            value="2024-12-14 00:00:00">
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qc_end">End Date and Time (UTC)</label>
                        <input type="datetime-local" id="datetime_qc_end" class="form-control"
                            value="2024-12-14 07:00:00">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qc" class="btn btn-primary align-bottom">Fetch Data</button>
                    </div>
                </div>
                {{ form.qc.label_tag }}
                {{ form.qc|add_class:"form-control" }}
                <div class="invalid-feedback">
                    Please provide a valid QC.
                </div>
                <div class="form-group row">
                    <div class="col-md-6">
                        {{ form.operator.label_tag }}
                        {{ form.operator|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please select a valid operator.
                        </div>
                    </div>
                    <div class="col-md-6">
                        {{ form.NIP.label_tag }}
                        {{ form.NIP|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please provide a valid NIP.
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="invalid-feedback">
                        Please provide a valid date.
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary"
                    onclick="window.location.href='{% url 'qc:qcrecord_list' %}'">Cancel</button>
        </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // set the date_input default value to today
        document.getElementById('date_input').valueAsDate = new Date();

        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');
                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // change qc_id value based on date_input and waktu_dinas
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('date_input');
            const waktuDinasSelect = document.getElementById('waktu_dinas');
            const qcIdInput = document.getElementById('{{ form.qc_id.id_for_label }}');
            qcIdInput.value = dateInput.value + "-" + waktuDinasSelect.value;

            function updateQcId() {
                const dateValue = dateInput.value;
                const waktuDinasValue = waktuDinasSelect.value;
                qcIdInput.value = dateValue + "-" + waktuDinasValue;
            }

            dateInput.addEventListener('change', updateQcId);
            waktuDinasSelect.addEventListener('change', updateQcId);
        });

        // Fetch data and fill qc_prev
        document.getElementById('fetch_qc_prev').addEventListener('click', function () {
            const startDatetime = document.getElementById('datetime_qc_prev_start').value.replace('T', ' ');
            const endDatetime = document.getElementById('datetime_qc_prev_end').value.replace('T', ' ');
            const url = `{% url 'qc:fetch_data' 'start_datetime' 'end_datetime' %}`
                .replace('start_datetime', encodeURIComponent(startDatetime))
                .replace('end_datetime', encodeURIComponent(endDatetime));

            fetch(url)
                .then(response => response.json()) // Assuming data is plain text
                .then(data => {
                    const qcPrevInput = document.querySelector('[name="{{ form.qc_prev.name }}"]');
                    qcPrevInput.value = data.csv;
                })
                .catch(error => console.error('Error fetching data:', error));
        });

        // Fetch data and fill qc
        document.getElementById('fetch_qc').addEventListener('click', function () {
            const startDatetime = document.getElementById('datetime_qc_start').value.replace('T', ' ');
            const endDatetime = document.getElementById('datetime_qc_end').value.replace('T', ' ');
            const url = `{% url 'qc:fetch_data' 'start_datetime' 'end_datetime' %}`
                .replace('start_datetime', encodeURIComponent(startDatetime))
                .replace('end_datetime', encodeURIComponent(endDatetime));

            fetch(url)
                .then(response => response.json()) // Assuming data is plain text
                .then(data => {
                    const qcInput = document.querySelector('[name="{{ form.qc.name }}"]');
                    qcInput.value = data.csv;
                })
                .catch(error => console.error('Error fetching data:', error));
        });

        // set the datetime_qc_prev_start and datetime_qc_prev_end default value to be dependent on the waktu_dinas
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('date_input');
            const waktuDinasSelect = document.getElementById('waktu_dinas');
            const datetimeQcPrevStart = document.getElementById('datetime_qc_prev_start');
            const datetimeQcPrevEnd = document.getElementById('datetime_qc_prev_end');
            const datetimeQcStart = document.getElementById('datetime_qc_start');
            const datetimeQcEnd = document.getElementById('datetime_qc_end');

            function updateDatetime() {
                const dateValue = dateInput.value;
                const waktuDinasValue = waktuDinasSelect.value;
                let startDatetime, endDatetime;

                switch (waktuDinasValue) {
                    case 'P':
                        const prevDay = new Date(dateValue);
                        prevDay.setDate(prevDay.getDate() - 1);
                        const prevDayValue = prevDay.toISOString().split('T')[0];
                        startDatetime = `${prevDayValue} 19:00:00`;
                        endDatetime = `${dateValue} 01:00:00`;
                        break;
                    case 'S':
                        startDatetime = `${dateValue} 01:00:00`;
                        endDatetime = `${dateValue} 07:00:00`;
                        break;
                    case 'M':
                        startDatetime = `${dateValue} 07:00:00`;
                        endDatetime = `${dateValue} 13:00:00`;
                        break;
                    case 'D':
                        startDatetime = `${dateValue} 13:00:00`;
                        endDatetime = `${dateValue} 19:00:00`;
                        break;
                }

                datetimeQcPrevStart.value = startDatetime;
                datetimeQcPrevEnd.value = endDatetime;
                datetimeQcStart.value = startDatetime;
                datetimeQcEnd.value = endDatetime;
            }

            dateInput.addEventListener('change', updateDatetime);
            waktuDinasSelect.addEventListener('change', updateDatetime);
            updateDatetime()

            function updateDatetimeQcPrevStart() {
                const dateValue = dateInput.value;
                const waktuDinasValue = waktuDinasSelect.value;
                qcIdInput.value = dateValue + "-" + waktuDinasValue;
            }
        });

        // Set NIP's value based on the selected operator
        document.addEventListener('DOMContentLoaded', function () {
            const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
            const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');

            function updateNip() {
                const selectedOperator = operatorSelect.value;
                fetch(`/qc/api/get_nip/${selectedOperator}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.nip) {
                            nipInput.value = data.nip;
                        } else {
                            console.error('Error fetching NIP:', data.error);
                        }
                    })
                    .catch(error => console.error('Error fetching NIP:', error));
            }

            operatorSelect.addEventListener('change', updateNip);
            updateNip();
        });
    </script>
{% endblock %}