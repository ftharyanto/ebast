{% extends 'core/base.html' %}
{% block content %}
<div class="form-container">
    <div class="container">
        <h1 class="mt-5">QC Record Form</h1>
        <p>Sumber data: <a href="http://202.90.198.41/index3.txt" target="_blank">http://202.90.198.41/index3.txt</a></p>
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            {% load form_tags %}

            {% if form.errors %}
            <div class="alert alert-danger">
                Please correct the errors below.
                <ul>
                    {% for field in form %}
                    {% if field.errors %}
                    {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            <div class="form-group row">
                <div class="col-md-4">
                    {{ form.date.label_tag }}
                    {{ form.date|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid date.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.shift.label_tag }}
                    {{ form.shift|add_class:"form-control" }}
                </div>
                <div class="col-md-4" style="display: none;">
                    {{ form.qc_id.label_tag }}
                    {{ form.qc_id|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid QC ID.
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="form-group col-md-4">
                        {{ form.kelompok.label_tag }}
                        {{ form.kelompok|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please select a valid kelompok.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.jam_pelaksanaan.label_tag }}
                        {{ form.jam_pelaksanaan|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please fill a valid jam pelaksanaan.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.kel_sebelum.id_for_label }}">Kelompok Sebelumnya</label>
                        {{ form.kel_sebelum|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please fill a valid kelompok sebelumnya.
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qc_prev_start">Start Date and Time (UTC)</label>
                        <input type="datetime" id="datetime_qc_prev_start" class="form-control"
                            value="2024-12-14 00:00:00">
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qc_prev_end">End Date and Time (UTC)</label>
                        <input type="datetime" id="datetime_qc_prev_end" class="form-control"
                            value="2024-12-14 07:00:00">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qc_prev" class="btn btn-primary align-bottom">Fetch
                            Data</button>
                    </div>
                </div>
                <!-- Accordion for fetched data and qc_prev form -->
                <div class="accordion" id="fetchedDataAccordion">
                    <div class="card">
                        <div class="card-header" id="headingOne">
                            <h2 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse"
                                    data-target="#fetchedDataSection" aria-expanded="true"
                                    aria-controls="fetchedDataSection">
                                    Fetched Data
                                </button>
                            </h2>
                        </div>

                        <div id="fetchedDataSection" class="collapse" aria-labelledby="headingOne"
                            data-parent="#fetchedDataAccordion">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover table-sm" id="fetched-data-table">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>No</th>
                                                <th>Date</th>
                                                <th>OT (UTC)</th>
                                                <th>Lat</th>
                                                <th>Long</th>
                                                <th>Mag</th>
                                                <th>TypeMag</th>
                                                <th>D(Km)</th>
                                                <th>Phase</th>
                                                <th>RMS</th>
                                                <th>Az. Gap</th>
                                                <th>Region</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                {{ form.qc_prev.label_tag }}
                                {{ form.qc_prev|add_class:"form-control" }}
                                <div class="form-group row">
                                    <div class="col-md-6">
                                        {{ form.event_indonesia.label_tag }}
                                        {{ form.event_indonesia|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.event_luar.label_tag }}
                                        {{ form.event_luar|add_class:"form-control" }}
                                    </div>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid previous QC.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qc_start">Start Date and Time (UTC)</label>
                        <input type="datetime" id="datetime_qc_start" class="form-control"
                            value="2024-12-14 00:00:00">
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qc_end">End Date and Time (UTC)</label>
                        <input type="datetime" id="datetime_qc_end" class="form-control" value="2024-12-14 07:00:00">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qc" class="btn btn-primary align-bottom">Fetch Data</button>
                    </div>
                </div>
                <!-- Accordion for fetched data and qc form -->
                <div class="accordion" id="qcDataAccordion">
                    <div class="card">
                        <div class="card-header" id="headingTwo">
                            <h2 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse"
                                    data-target="#qcDataSection" aria-expanded="true" aria-controls="qcDataSection">
                                    Fetched QC Data
                                </button>
                            </h2>
                        </div>

                        <div id="qcDataSection" class="collapse" aria-labelledby="headingTwo"
                            data-parent="#qcDataAccordion">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover table-sm" id="qc-data-table">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>No</th>
                                                <th>Date</th>
                                                <th>OT (UTC)</th>
                                                <th>Lat</th>
                                                <th>Long</th>
                                                <th>Mag</th>
                                                <th>TypeMag</th>
                                                <th>D(Km)</th>
                                                <th>Phase</th>
                                                <th>RMS</th>
                                                <th>Az. Gap</th>
                                                <th>Region</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                {{ form.qc.label_tag }}
                                {{ form.qc|add_class:"form-control" }}
                                <div class="invalid-feedback">
                                    Please provide a valid QC.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-6">
                    {{ form.operator.label_tag }}
                    {{ form.operator|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please select a valid operator.
                    </div>
                </div>
                <div class="col-md-6" id="nip-container">
                    {{ form.NIP.label_tag }}
                    {{ form.NIP|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid NIP.
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end align-items-bottom">
                    <button id="save-nip-button" type="button" class="btn btn-success ml-2" style="display: none;">Save NIP</button>
                    <div class="invalid-feedback">
                        Please provide a valid NIP.
                    </div>
                </div>
            </div>

            <!-- Modal for NIP notification -->
            <div class="modal fade" id="nipModal" tabindex="-1" role="dialog" aria-labelledby="nipModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="nipModalLabel">NIP Notification</h5>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Data NIP belum ada di database, silakan isi NIP Anda dan klik tombol "Save NIP".
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="invalid-feedback">
                    Please provide a valid date.
                </div>
            </div>
            {% if form.errors %}
            <div class="alert alert-danger">
                Please correct the errors below.
                <ul>
                    {% for field in form %}
                    {% if field.errors %}
                    {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary"
                onclick="window.location.href='{% url 'qc:qcrecord_list' %}'">Cancel</button>
        </form>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    // date picker initialization
    document.addEventListener('DOMContentLoaded', function () {
                    const dateInput = document.getElementById('{{ form.date.id_for_label }}');
                    dateInput.type = 'date';
                });

    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // change qc_id value based on date_input and waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const qcIdInput = document.getElementById('{{ form.qc_id.id_for_label }}');
        qcIdInput.value = "QC-" + dateInput.value + "-" + waktuDinasSelect.value[0];

        function updateQcId() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            qcIdInput.value = "QC-" + dateValue + "-" + waktuDinasValue[0];
        }

        dateInput.addEventListener('change', updateQcId);
        waktuDinasSelect.addEventListener('change', updateQcId);
    });

    // Fetch data and fill qc_prev
    document.getElementById('fetch_qc_prev').addEventListener('click', function () {
        const startDatetime = document.getElementById('datetime_qc_prev_start').value.replace('T', ' ');
        const endDatetime = document.getElementById('datetime_qc_prev_end').value.replace('T', ' ');
        const url = `{% url 'qc:fetch_data' 'start_datetime' 'end_datetime' %}`
            .replace('start_datetime', encodeURIComponent(startDatetime))
            .replace('end_datetime', encodeURIComponent(endDatetime));

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const qcPrevInput = document.querySelector('[name="{{ form.qc_prev.name }}"]');
                qcPrevInput.value = data.csv;

                // Populate the table with fetched data
                const tableBody = document.getElementById('fetched-data-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Simulate a click on the accordion button if not already expanded
                const fetchedDataSection = document.getElementById('fetchedDataSection');
                if (!fetchedDataSection.classList.contains('show')) {
                    document.querySelector('[data-target="#fetchedDataSection"]').click();
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    });

    // Fetch data and fill qc
    document.getElementById('fetch_qc').addEventListener('click', function () {
        const startDatetime = document.getElementById('datetime_qc_start').value.replace('T', ' ');
        const endDatetime = document.getElementById('datetime_qc_end').value.replace('T', ' ');
        const url = `{% url 'qc:fetch_data' 'start_datetime' 'end_datetime' %}`
            .replace('start_datetime', encodeURIComponent(startDatetime))
            .replace('end_datetime', encodeURIComponent(endDatetime));

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const qcInput = document.querySelector('[name="{{ form.qc.name }}"]');
                qcInput.value = data.csv;

                // Populate the table with fetched data
                const tableBody = document.getElementById('qc-data-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Simulate a click on the accordion button if not already expanded
                const qcDataSection = document.getElementById('qcDataSection');
                if (!qcDataSection.classList.contains('show')) {
                    document.querySelector('[data-target="#qcDataSection"]').click();
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    });

    // set the datetime_qc_prev_start and datetime_qc_prev_end default value to be dependent on the waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const datetimeQcPrevStart = document.getElementById('datetime_qc_prev_start');
        const datetimeQcPrevEnd = document.getElementById('datetime_qc_prev_end');
        const datetimeQcStart = document.getElementById('datetime_qc_start');
        const datetimeQcEnd = document.getElementById('datetime_qc_end');

        function updateDatetime() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            let startDatetime, endDatetime;

            const prevDay = new Date(dateValue);
            prevDay.setDate(prevDay.getDate() - 1);
            const prevDayValue = prevDay.toISOString().split('T')[0];

            switch (waktuDinasValue[0]) {
                case 'P':
                    startDatetime = `${prevDayValue} 19:00:00`;
                    endDatetime = `${dateValue} 01:00:00`;
                    break;
                case 'S':
                    startDatetime = `${dateValue} 01:00:00`;
                    endDatetime = `${dateValue} 07:00:00`;
                    break;
                case 'M':
                    startDatetime = `${dateValue} 07:00:00`;
                    endDatetime = `${dateValue} 13:00:00`;
                    break;
                case 'D':
                    startDatetime = `${prevDayValue} 13:00:00`;
                    endDatetime = `${prevDayValue} 19:00:00`;
                    break;
            }

            datetimeQcPrevStart.value = startDatetime;
            datetimeQcPrevEnd.value = endDatetime;
            datetimeQcStart.value = startDatetime;
            datetimeQcEnd.value = endDatetime;
        }

        dateInput.addEventListener('change', updateDatetime);
        waktuDinasSelect.addEventListener('change', updateDatetime);
        updateDatetime()

        function updateDatetimeQcPrevStart() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            qcIdInput.value = dateValue + "-" + waktuDinasValue;
        }
    });

    // Set NIP's value based on the selected operator and handle "Save NIP" button
    document.addEventListener('DOMContentLoaded', function () {
        const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
        const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');
        const saveButton = document.getElementById('save-nip-button');
        const nipContainer = document.getElementById('nip-container');

        function updateNip() {
            const selectedOperator = operatorSelect.value;
            fetch(`/qc/api/get_nip/${selectedOperator}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.nip) {
                        nipInput.value = data.nip;
                        saveButton.style.display = 'none'; // Hide the button
                        nipContainer.classList.remove('col-md-4');
                        nipContainer.classList.add('col-md-6');
                    } else {
                        nipInput.value = '';
                        saveButton.style.display = 'inline-block'; // Show the button
                        nipContainer.classList.remove('col-md-6');
                        nipContainer.classList.add('col-md-4');

                        // Show modal when NIP is empty
                        const nipModal = new bootstrap.Modal(document.getElementById('nipModal'));
                        nipModal.show();
                    }
                })
                .catch(error => console.error('Error fetching NIP:', error));
        }

        operatorSelect.addEventListener('change', updateNip);
        updateNip();
    });

    // Handle "Save NIP" button click
    document.addEventListener('DOMContentLoaded', function () {
        const saveButton = document.getElementById('save-nip-button');
        const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
        const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');

        saveButton.addEventListener('click', function () {
            const operatorId = operatorSelect.value;
            const nip = nipInput.value;

            if (!operatorId || !nip) {
                alert('Please select an operator and provide a valid NIP.');
                return;
            }

            fetch("{% url 'qc:save_nip' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ operator_id: operatorId, nip: nip })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.success);
                    saveButton.style.display = 'none';
                } else {
                    alert(data.error || 'Failed to save NIP.');
                }
            })
            .catch(error => console.error('Error saving NIP:', error));
        });
    });

    // Show modal when NIP is empty
    document.addEventListener('DOMContentLoaded', function () {
        const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
        const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');
        const nipModalElement = document.getElementById('nipModal');
        const nipModal = new bootstrap.Modal(nipModalElement);
    });
</script>
{% endblock %}