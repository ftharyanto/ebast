{% extends 'core/base.html' %}
{% load static %}

{% block title %}BAST Records Tabulator{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">BAST Records Tabulator</h1>
    <div class="container-fluid mt-3">
        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div class="d-flex flex-wrap align-items-center w-100 w-md-auto gap-2">
                    <!-- Export and Search controls -->
                    <div class="input-group input-group-sm me-2" style="min-width: 250px;">
                        <button id="export-csv" class="btn btn-sm btn-outline-primary me-2" title="Export to CSV">
                            <i class="fas fa-file-export me-1"></i> Export All to CSV
                        </button>
                        <button id="export-selected-excel" class="btn btn-sm btn-outline-primary me-2" title="Export to Excel">
                            <i class="fas fa-file-export me-1"></i> Export Selected to Excel
                        </button>
                        <button id="export-selected-pdf" class="btn btn-sm btn-outline-primary me-2" title="Export to PDF">
                            <i class="fas fa-file-pdf me-1"></i> Export Selected to PDF
                        </button>
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="globalSearch" class="form-control" placeholder="Search in all columns...">
                        <button id="clearSearch" class="btn btn-outline-secondary" type="button" title="Clear search" style="border-color: #dee2e6;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column" style="height: calc(100vh - 200px);">
                <div style="flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
                    <div id="tabulator-table" class="loading" style="flex: 1; min-height: 0; min-width: 100%;"></div>
                </div>
        </div>
    </div>
</div>

<!-- Include Luxon for date formatting -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

<!-- Include Tabulator CSS and Themes -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
<!-- Include Tabulator JS -->
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<!-- Initialize Tabulator -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Tabulator...');
    
    // Function to perform global search
    function performGlobalSearch() {
        var searchValue = document.getElementById('globalSearch').value.toLowerCase();
        
        if (searchValue === '') {
            table.clearFilter();
            return;
        }
        
        // Create a filter function that checks all string fields
        table.setFilter(function(data) {
            // Check each property of the row
            for (var key in data) {
                // Skip internal Tabulator fields and functions
                if (typeof data[key] === 'function' || key === 'id' || key === '_row' || key === 'table') {
                    continue;
                }
                
                // Get the value and convert to string
                var value = data[key];
                if (value === null || value === undefined) {
                    continue;
                }
                
                // Convert to string and check if it contains the search term
                var stringValue = String(value).toLowerCase();
                if (stringValue.includes(searchValue)) {
                    return true;
                }
            }
            return false;
        });
    }
    
    // Add event listeners for search
    document.addEventListener('DOMContentLoaded', function() {
        var searchInput = document.getElementById('globalSearch');
        var clearSearchBtn = document.getElementById('clearSearch');
        var searchTimeout;
        
        // Search on input with debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performGlobalSearch, 300);
        });
        
        // Clear search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            table.clearFilter();
        });
        
        // Search on Enter key
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                performGlobalSearch();
            } else if (e.key === 'Escape') {
                searchInput.value = '';
                table.clearFilter();
            }
        });
    });
    
    // Function to update status bar and pagination
    function updateStatusBar() {
        const dataCount = table.getDataCount('active');
        const totalCount = table.getDataCount();
        const pageSize = table.getPageSize();
        const pageMax = table.getPageMax();
        const currentPage = table.getPage();
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, dataCount);
        const selectedCount = table.getSelectedRows().length;
        
        // Update pagination info
        document.getElementById('showing-start').textContent = start.toLocaleString();
        document.getElementById('showing-end').textContent = end.toLocaleString();
        document.getElementById('total-entries').textContent = dataCount.toLocaleString();
        
        // Update selected count
        const selectedEl = document.getElementById('selected-count');
        if (selectedCount > 0) {
            selectedEl.textContent = selectedCount.toLocaleString();
            document.getElementById('selected-info').classList.remove('d-none');
        } else {
            document.getElementById('selected-info').classList.add('d-none');
        }
        
        // Show filtered info if data is filtered
        const filteredInfoEl = document.getElementById('filtered-info');
        if (dataCount !== totalCount) {
            document.getElementById('total-unfiltered').textContent = totalCount.toLocaleString();
            filteredInfoEl.classList.remove('d-none');
        } else {
            filteredInfoEl.classList.add('d-none');
        }
        
        // Update pagination button states
        document.getElementById('first-page').disabled = currentPage === 1;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage >= pageMax;
        document.getElementById('last-page').disabled = currentPage >= pageMax;
        
        // Update page size selector
        const pageSizeSelect = document.getElementById('page-size');
        if (pageSizeSelect.value !== pageSize.toString()) {
            pageSizeSelect.value = pageSize;
        }
    }
    
    // Initialize Tabulator with horizontal scrolling
    var table = new Tabulator("#tabulator-table", {
        // Disable header filters
        headerFilterLiveFilter: false,
        
        // Custom filter function for case-insensitive search
        dataFiltered: function(filters, rows) {
            // Update the counter when data is filtered
            var count = rows.length;
            var el = document.getElementById('filter-count');
            if (el) {
                el.textContent = count + ' records found';
            }
        },
        layout: "fitDataTable",
        responsiveLayout: false,
        pagination: "local",
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100],
        movableColumns: true,
        height: "100%",
        columnMinWidth: 80,
        virtualDom: true,
        
        // Selection settings
        selectable: true,
        selectableRangeMode: false,
        selectableRollingSelection: true,
        selectablePersistence: true,
        selectableCheck: function(row) {
            // You can add custom logic here to make rows unselectable
            return true;
        },
        addRowPos: "top",
        history: true,
        paginationCounter: "rows",
        ajaxURL: "/bast/api/bastrecord-list/",
        ajaxConfig: "GET",
        ajaxContentType: "json",
        ajaxResponse: function(url, params, response) {
            console.log('AJAX Response received. Record count:', response ? response.length : 0);
            if (response && response.length > 0) {
                console.log('First record:', response[0]);
            }
            document.getElementById('tabulator-table').classList.remove('loading');
            return response;
        },
        ajaxError: function(xhr, status, error) {
            console.error('AJAX Error:', status, error);
            console.error('Response text:', xhr.responseText);
            document.getElementById('tabulator-table').classList.remove('loading');
            return [];
        },
        movableColumns: true,
        selectable: true,
        // Disable header filters
        dataLoaded: function(data) {
            console.log('Data loaded into Tabulator. Row count:', data.length);
            if (data.length > 0) {
                console.log('First row data:', data[0]);
            }
            updateStatusBar();
        },
        dataLoadError: function(error) {
            console.error('Data load error:', error);
        },
        
        // Initialize scroll buttons and pagination controls
        tableBuilt: function() {
            const table = this;
            
            // Pagination event handlers
            document.getElementById('first-page').addEventListener('click', () => table.setPage(1));
            document.getElementById('prev-page').addEventListener('click', () => table.previousPage());
            document.getElementById('next-page').addEventListener('click', () => table.nextPage());
            document.getElementById('last-page').addEventListener('click', () => table.setPage('last'));
            
            // Page size change handler
            document.getElementById('page-size').addEventListener('change', function() {
                table.setPageSize(parseInt(this.value));
                table.setPage(1);
            });
            
            // Update status when data changes
            table.on([
                'pageLoaded',
                'pageSizeChanged',
                'dataFiltered',
                'dataSorted',
                'rowSelectionChanged'
            ], updateStatusBar);
            
            // Selection controls
            document.getElementById('select-all').addEventListener('click', () => {
                table.selectRow();
                updateStatusBar();
            });
            
            document.getElementById('deselect-all').addEventListener('click', () => {
                table.deselectRow();
                updateStatusBar();
            });
            
            document.getElementById('select-invert').addEventListener('click', () => {
                const rows = table.getRows();
                rows.forEach(row => row.toggleSelect());
                updateStatusBar();
            });
            
            // Delete Confirmation Modal
            const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            const deleteModalBody = document.getElementById('deleteConfirmationModal').querySelector('.modal-body');
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            
            document.getElementById('delete-selected').addEventListener('click', () => {
                const selectedRows = table.getSelectedRows();
                if (selectedRows.length > 0) {
                    deleteModalBody.innerHTML = `Are you sure you want to delete ${selectedRows.length} selected record(s)?`;
                    
                    // Store the selected rows in the modal's dataset
                    deleteConfirmationModal._element.dataset.rows = JSON.stringify(selectedRows.map(row => row.getData().id));
                    
                    // Show the modal
                    deleteConfirmationModal.show();
                } else {
                    showErrorModal('Please select at least one record to delete');
                }
            });
            
            // Handle the actual delete when confirmed
            confirmDeleteButton.addEventListener('click', () => {
                const selectedIds = JSON.parse(deleteConfirmationModal._element.dataset.rows || '[]');
                
                // Here you would typically make an AJAX call to delete the records
                console.log('Deleting records with IDs:', selectedIds);
                
                // For now, just remove the rows from the table
                const selectedRows = table.getSelectedRows();
                selectedRows.forEach(row => row.delete());
                
                // Show success message
                showSuccessModal(`${selectedRows.length} record(s) deleted successfully`);
                
                // Update the status bar
                updateStatusBar();
                
                // Hide the modal
                deleteConfirmationModal.hide();
            });
            
            // Update status when selection changes
            table.on('rowSelectionChanged', updateStatusBar);
            
            // Initial status update
            updateStatusBar();
            const tableElement = document.querySelector('.tabulator-tableholder');
            const scrollLeftBtn = document.getElementById('scroll-left');
            const scrollRightBtn = document.getElementById('scroll-right');
            
            // Update button states
            const updateButtonStates = () => {
                scrollLeftBtn.disabled = tableElement.scrollLeft === 0;
                scrollRightBtn.disabled = tableElement.scrollLeft >= (tableElement.scrollWidth - tableElement.clientWidth - 5);
            };
            
            // Scroll left
            scrollLeftBtn.addEventListener('click', () => {
                tableElement.scrollBy({ left: -200, behavior: 'smooth' });
                setTimeout(updateButtonStates, 300);
            });
            
            // Scroll right
            scrollRightBtn.addEventListener('click', () => {
                tableElement.scrollBy({ left: 200, behavior: 'smooth' });
                setTimeout(updateButtonStates, 300);
            });
            
            // Update on scroll
            tableElement.addEventListener('scroll', updateButtonStates);
            
            // Initial state
            updateButtonStates();
        },
        columns: [
            // Row selection column
            {
                title: "",
                field: "select",
                headerSort: false,
                resizable: false,
                width: 40,
                formatter: "rowSelection",
                titleFormatter: "rowSelection",
                hozAlign: "center",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.getRow().toggleSelect();
                }
            },
            { title: "ID", field: "id", width: 80, hozAlign: "right" },
            { 
                title: "BAST ID", 
                field: "bast_id", 
                width: 180,
                formatter: function(cell, formatterParams, onRendered) {
                    const value = cell.getValue();
                    return value || '';
                }
            },
            { 
                title: "Date", 
                field: "date", 
                width: 120, 
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.substring(0, 10) : '';
                }
            },
            { 
                title: "Waktu Pelaksanaan", 
                field: "waktu_pelaksanaan", 
                width: 150,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Shift", 
                field: "shift", 
                width: 100,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Kelompok", 
                field: "kelompok", 
                width: 100,
                hozAlign: "center"
            },
            { 
                title: "Kelompok Berikut", 
                field: "kel_berikut", 
                width: 120,
                hozAlign: "center"
            },
            { 
                title: "SPV ID", 
                field: "spv", 
                width: 100,
                hozAlign: "right",
                visible: false // Hidden by default as we show spv_name
            },
            { 
                title: "SPV Name", 
                field: "spv_name", 
                width: 200,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "NIP", 
                field: "NIP", 
                width: 150,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Event Indonesia", 
                field: "event_indonesia", 
                width: 100, 
                hozAlign: "right" 
            },
            { 
                title: "Event Luar", 
                field: "event_luar", 
                width: 100, 
                hozAlign: "right" 
            },
            { 
                title: "Event Dirasakan", 
                field: "event_dirasakan", 
                width: 120, 
                hozAlign: "right" 
            },
            { 
                title: "Event Dikirim", 
                field: "event_dikirim", 
                width: 120, 
                hozAlign: "right" 
            },
            { 
                title: "Gaps", 
                field: "count_gaps", 
                width: 80, 
                hozAlign: "right" 
            },
            { 
                title: "Spikes", 
                field: "count_spikes", 
                width: 80, 
                hozAlign: "right" 
            },
            { 
                title: "Blanks", 
                field: "count_blanks", 
                width: 80, 
                hozAlign: "right" 
            },
            { 
                title: "Waktu CS", 
                field: "waktu_cs", 
                width: 120,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Pulsa Poco", 
                field: "pulsa_poco", 
                width: 120, 
                hozAlign: "right" 
            },
            { 
                title: "Poco Expiry", 
                field: "poco_exp", 
                width: 120, 
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.substring(0, 10) : '';
                }
            },
            { 
                title: "Samsung Expiry", 
                field: "samsung_exp", 
                width: 140, 
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.substring(0, 10) : '';
                }
            },
            { 
                title: "Events Data", 
                field: "events", 
                width: 150,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? 'View Events' : '';
                },
                cellClick: function(e, cell) {
                    const data = cell.getRow().getData();
                    if (data.events) {
                        // Show events in a modal or new window
                        const win = window.open('', '_blank');
                        win.document.write(`<pre>${data.events}</pre>`);
                    }
                },
                cssClass: 'clickable-cell'
            },
            { 
                title: "Members", 
                field: "member", 
                width: 150,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? 'View Members' : '';
                },
                cellClick: function(e, cell) {
                    const data = cell.getRow().getData();
                    if (data.member) {
                        try {
                            const members = JSON.parse(data.member);
                            let html = '<table class="table table-bordered"><thead><tr><th>Nama</th><th>Keterangan</th></tr></thead><tbody>';
                            members.forEach(m => {
                                html += `<tr><td>${m.nama || ''}</td><td>${m.keterangan || ''}</td></tr>`;
                            });
                            html += '</tbody></table>';
                            
                            // Show in a modal instead of a new window
                            const modalBody = document.getElementById('membersModalBody');
                            if (modalBody) {
                                modalBody.innerHTML = html;
                                const modal = new bootstrap.Modal(document.getElementById('membersModal'));
                                modal.show();
                            } else {
                                // Fallback to window.open if modal not found
                                const win = window.open('', '_blank');
                                win.document.write(html);
                            }
                        } catch (e) {
                            showErrorModal('Error parsing members data');
                        }
                    }
                },
                cssClass: 'clickable-cell'
            },
            { 
                title: "Notes", 
                field: "notes", 
                width: 200, 
                formatter: "textarea",
                formatterParams: {
                    maxHeight: 100
                }
            }
        ],
        ajaxRequesting: function(url, params) {
            console.log('AJAX Request:', url, params);
            // Show loading state
            document.getElementById('tabulator-table').classList.add('loading');
        },
        ajaxResponse: function(url, params, response) {
            console.log('AJAX Response:', url, response);
            // Hide loading state
            document.getElementById('tabulator-table').classList.remove('loading');
            return response;
        },
        ajaxError: function(xhr, textStatus, errorThrown) {
            console.error('AJAX Error:', textStatus, errorThrown);
            document.getElementById('tabulator-table').classList.remove('loading');
            return [];
        }
    });

    // Add loading state style
    document.getElementById('tabulator-table').classList.add('loading');

    // Handle row click to view details
    table.on("rowClick", function(e, row) {
        const bastId = row.getData().bast_id;
        window.location.href = `/bast/bastrecord/${bastId}/`;
    });

    // Clear selection when clicking outside the table
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#tabulator-table')) {
            table.deselectRow();
        }
    });

    // Add delete confirmation
    document.addEventListener('click', function(e) {
        if (e.target.closest('.tabulator-delete')) {
            if (confirm('Are you sure you want to delete this record?')) {
                const row = table.getRow(e.target.closest('.tabulator-row'));
                const bastId = row.getData().bast_id;
                fetch(`/bast/bastrecord/delete/${bastId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                }).then(response => {
                    if (response.ok) {
                        row.delete();
                    }
                });
            }
        }
    });

    // Global search functionality
    document.getElementById('globalSearch').addEventListener('input', function(e) {
        const searchValue = e.target.value.toLowerCase();
        table.setFilter(function(data) {
            return [
                'bast_id', 'waktu_pelaksanaan', 'shift', 'kelompok', 'kel_berikut',
                'spv_name', 'NIP', 'waktu_cs', 'notes'
            ].some(field => {
                const value = data[field];
                return value !== null && value !== undefined && 
                       value.toString().toLowerCase().includes(searchValue);
            }) || [
                'event_indonesia', 'event_luar', 'event_dirasakan', 'event_dikirim',
                'count_gaps', 'count_spikes', 'count_blanks', 'pulsa_poco'
            ].some(field => {
                return data[field] !== null && data[field] !== undefined && 
                       data[field].toString().includes(searchValue);
            }) || [
                'date', 'poco_exp', 'samsung_exp'
            ].some(field => {
                return data[field] && new Date(data[field]).toISOString().includes(searchValue);
            });
        });
    });

    // Clear search button
    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('globalSearch').value = '';
        table.clearFilter();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search with Ctrl+F or Cmd+F
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('globalSearch').focus();
            document.getElementById('globalSearch').select();
        }
        // Clear search with Escape
        else if (e.key === 'Escape' && document.activeElement === document.getElementById('globalSearch')) {
            e.preventDefault();
            document.getElementById('globalSearch').value = '';
            table.clearFilter();
        }
    });

    // Export to CSV button click handler
    document.getElementById('export-csv').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        
        try {
            // Make a fetch request to the export endpoint
            const response = await fetch('/bast/export-csv/');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get the blob data
            const blob = await response.blob();
            
            // Create a temporary URL for the blob
            const url = window.URL.createObjectURL(blob);
            
            // Create a temporary link and trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bast_records_export.csv';
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Show success message
            showSuccessModal('Export completed successfully!');
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });

    // Export Selected to Excel button click handler
    document.getElementById('export-selected-excel').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        
        try {
            // Get selected records from the table
            const selectedRows = table.getSelectedRows();
            
            if (selectedRows.length === 0) {
                showErrorModal('Please select at least one record to export');
                button.disabled = false;
                button.innerHTML = originalText;
                return;
            }
    
            // Update button text to show progress
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting 0/${selectedRows.length}...`;
            
            // Process each selected record
            for (let i = 0; i < selectedRows.length; i++) {
                const row = selectedRows[i];
                const recordId = row.getData().id;
                
                try {
                    // Update progress
                    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting ${i + 1}/${selectedRows.length}...`;
                    
                    // Make a fetch request for each record
                    const response = await fetch(`/bast/export-to-excel/${recordId}/`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for record ${recordId}`);
                    }
                    
                    // Get the blob data and filename from the response
                    const blob = await response.blob();
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/['"]+/g, '');
                    
                    // Create a temporary URL for the blob
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger the download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `bast_record_${recordId}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Small delay between downloads to avoid overwhelming the browser
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error exporting record ${recordId}:`, error);
                    // Continue with next record even if one fails
                    continue;
                }
            }
            
            // Show completion message
            showSuccessModal(`Successfully exported ${selectedRows.length} record(s)`);
            
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }); 

    // Export Selected to PDF button click handler
    document.getElementById('export-selected-pdf').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        
        try {
            // Get selected records from the table
            const selectedRows = table.getSelectedRows();
            
            if (selectedRows.length === 0) {
                showErrorModal('Please select at least one record to export');
                button.disabled = false;
                button.innerHTML = originalText;
                return;
            }
    
            // Update button text to show progress
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting 0/${selectedRows.length}...`;
            
            // Process each selected record
            for (let i = 0; i < selectedRows.length; i++) {
                const row = selectedRows[i];
                const recordId = row.getData().id;
                
                try {
                    // Update progress
                    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting ${i + 1}/${selectedRows.length}...`;
                    
                    // Make a fetch request for each record
                    const response = await fetch(`/bast/export-to-pdf/${recordId}/`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for record ${recordId}`);
                    }
                    
                    // Get the blob data and filename from the response
                    const blob = await response.blob();
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/['"]+/g, '');
                    
                    // Create a temporary URL for the blob
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger the download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `bast_record_${recordId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Small delay between downloads to avoid overwhelming the browser
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error exporting record ${recordId}:`, error);
                    // Continue with next record even if one fails
                    continue;
                }
            }
            
            // Show completion message
            showSuccessModal(`Successfully exported ${selectedRows.length} record(s)`);
            
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }); 

    // Function to show error modal
    function showErrorModal(message) {
        const errorContent = document.getElementById('errorModalContent');
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        
        if (errorContent) {
            errorContent.textContent = message;
            errorModal.show();
        } else {
            // Fallback to alert if modal not found
            console.error('Error modal not found. Message:', message);
            alert(message);
        }
    }
    
    // Function to show success modal
    function showSuccessModal(message) {
        const successContent = document.getElementById('successModalContent');
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        
        if (successContent) {
            successContent.textContent = message;
            successModal.show();
        } else {
            // Fallback to alert if modal not found
            console.log('Success modal not found. Message:', message);
            alert(message);
        }
    }
});
</script>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="successModalContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal (should be in base.html, but adding here as fallback) -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="errorModalContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Members Modal -->
<div class="modal fade" id="membersModal" tabindex="-1" aria-labelledby="membersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="membersModalLabel">Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="membersModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
