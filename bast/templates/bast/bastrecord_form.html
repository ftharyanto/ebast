{% extends 'core/base.html' %}
{% block content %}
<div class="form-container">
    <div class="container">
        <h1 class="page-header">BAST Record Form</h1>
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            {% load form_tags %}

            {% if form.errors %}
            <div id="form-errors" data-errors="true" style="display: none;">
                {% for field in form %}
                {% if field.errors %}
                {% for error in field.errors %}
                <div data-field="{{ field.id_for_label }}" data-error="{{ error|escapejs }}"></div>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="form-group row">
                <div class="col-md-4">
                    {{ form.date.label_tag }}
                    <div class="input-group date-picker-wrapper">
                        {{ form.date|add_class:"form-control date-picker" }}
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                    <div class="invalid-feedback">
                        Please provide a valid date.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.shift.label_tag }}
                    {{ form.shift|add_class:"form-select" }}
                </div>
                <div class="col-md-4">
                    {{ form.bast_id.label_tag }}
                    <input type="text" name="{{ form.bast_id.name }}" value="{{ form.bast_id.value|default:'' }}" class="form-control bg-light" id="{{ form.bast_id.id_for_label }}" readonly style="cursor: not-allowed;">
                    <div class="invalid-feedback">
                        Please provide a valid BAST ID.
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="form-group col-md-4">
                        {{ form.kelompok.label_tag }}
                        {{ form.kelompok|add_class:"form-select" }}
                        <div class="invalid-feedback">
                            Please select a valid kelompok.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.kel_berikut.id_for_label }}">Kelompok Berikutnya</label>
                        {{ form.kel_berikut|add_class:"form-select" }}
                        <div class="invalid-feedback">
                            Please fill a valid kelompok berikutnya.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.waktu_pelaksanaan.label_tag }}
                        {{ form.waktu_pelaksanaan|add_class:"form-select" }}
                        <div class="invalid-feedback">
                            Please select a valid waktu pelaksanaan.
                        </div>
                    </div>

                    <!-- create a table of members from "Kelompok" model -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <div class="row">
                            <div class="col-md-12 text-right">
                                <button type="button" id="fetch-prev-members-btn"
                                    class="btn btn-primary btn-sm text-white">
                                    <i class="fas fa-users mr-1"></i> Fetch Previous Members
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive container" style="padding-right: 5em; padding-left: 5em;">
                        <table class="table table-bordered table-hover table-sm" id="member-data-table"
                            style="width: auto;">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 1%;">No</th>
                                    <th style="width: 20%;">Nama</th>
                                    <th style="width: 20%;">Keterangan
                                        <span data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="Isi keterangan dengan nama pengganti atau keterangan izin/cuti/SPT. Contoh: diganti Fajar">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="form-group col-md-4" style="display: none;">
                        {{ form.member.label_tag }}
                        {{ form.member|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please provide a valid member.
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_bast_start">Start Date and Time (UTC)</label>
                        <div class="input-group date-picker-wrapper">
                            <input type="datetime" id="datetime_bast_start" class="form-control datetime-picker"
                                value="2024-12-14 00:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_bast_end">End Date and Time (UTC)</label>
                        <div class="input-group date-picker-wrapper">
                            <input type="datetime" id="datetime_bast_end" class="form-control datetime-picker"
                                value="2024-12-14 07:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_bast" class="btn btn-primary align-bottom">Fetch
                            Data</button>
                    </div>
                </div>
                <!-- Accordion for fetched data and bast form -->
                <div class="accordion" id="fetchedDataAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#fetchedDataSection" aria-expanded="false"
                                aria-controls="fetchedDataSection">
                                <b>Fetched Data</b>
                            </button>
                        </h2>
                        <div id="fetchedDataSection" class="accordion-collapse collapse" 
                            aria-labelledby="headingOne" data-bs-parent="#fetchedDataAccordion">
                            <div class="accordion-body p-0">
                                <div class="d-flex justify-content-between align-items-center mb-2 px-3 pt-3">
                                    <small class="text-muted">Earthquake Events Data</small>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="openTableModal">
                                        <i class="fas fa-expand"></i> View in Larger Table
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 300px; overflow-x: auto; font-size: 0.85rem;">
                                    <table class="table table-bordered table-striped table-hover table-sm mb-0"
                                        id="fetched-data-table" style="min-width: 1100px;">
                                        <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
                                            <tr>
                                                <th style="width: 40px;">No</th>
                                                <th>Date</th>
                                                <th>OT (UTC)</th>
                                                <th>Lat</th>
                                                <th>Long</th>
                                                <th>D(Km)</th>
                                                <th>Mag</th>
                                                <th>TypeMag</th>
                                                <th>Region</th>
                                                <th>MMI
                                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                                        title="Contoh: dirasakan di Kolaka Timur III MMI">
                                                        <i class="fas fa-info-circle"></i>
                                                    </span>
                                                </th>
                                                <th>Dis. PGN (UTC)
                                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                                        title="Waktu diseminasi oleh PGN dalam UTC. Contoh: 20:25:03">
                                                        <i class="fas fa-info-circle"></i>
                                                    </span>
                                                </th>
                                                <th>Selisih PGN</th>
                                                <th>Dis. PGR (UTC)
                                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                                        title="Waktu diseminasi oleh PGR dalam UTC. Contoh: 20:25:03">
                                                        <i class="fas fa-info-circle"></i>
                                                    </span>
                                                </th>
                                                <th>Selisih PGR</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <label for="{{ form.events.id_for_label }}">Events (in CSV format):</label>
                                    {{ form.events|add_class:"form-control" }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row mt-3">
                        <div class="col-md-3">
                            {{ form.event_indonesia.label_tag }}
                            {{ form.event_indonesia|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid event Indonesia.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.event_luar.label_tag }}
                            {{ form.event_luar|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid event luar.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.event_dirasakan.label_tag }}
                            {{ form.event_dirasakan|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid event dirasakan.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.event_dikirim.label_tag }}
                            {{ form.event_dikirim|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid event dikirim.
                            </div>
                        </div>
                    </div>
                    <div class="form-group row mt-3">
                        <div class="col-md-3">
                            <label for="{{ form.waktu_cs.id_for_label }}">Jam ceklis seiscomp</label>
                            {{ form.waktu_cs|add_class:"form-select" }}
                            <div class="invalid-feedback">
                                Please provide a valid count waktu ceklis seiscomp.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.count_gaps.label_tag }}
                            {{ form.count_gaps|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid count gaps.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.count_spikes.label_tag }}
                            {{ form.count_spikes|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid count spikes.
                            </div>
                        </div>
                        <div class="col-md-3">
                            {{ form.count_blanks.label_tag }}
                            {{ form.count_blanks|add_class:"form-control" }}
                            <div class="invalid-feedback">
                                Please provide a valid count blanks.
                            </div>
                        </div>
                    </div>
                    <div class="form-group row mt-3">
                        <div class="col-md-3">
                            <label for="{{ form.pulsa_poco.id_for_label }}" class="form-label">Pulsa Poco:</label>
                            <div class="input-group" style="width: 100%;">
                                {{ form.pulsa_poco|add_class:"form-control" }}
                                <button class="btn btn-fetch-previous" type="button" id="fetchPreviousPulsaPoco"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="Fetch previous Pulsa Poco value">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Please provide a valid pulsa poco.
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.poco_exp.id_for_label }}" class="form-label">Poco Expiration
                                Date:</label>
                            <div class="input-group date-picker-wrapper" style="width: 100%;">
                                {{ form.poco_exp|add_class:"form-control date-picker" }}
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                <button class="btn btn-fetch-previous" type="button" id="fetchPreviousPocoExp"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="Fetch previous Poco Expiration Date value">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Please provide a valid poco exp.
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.samsung_exp.id_for_label }}" class="form-label">Samsung Expiration
                                Date:</label>
                            <div class="input-group date-picker-wrapper" style="width: 100%;">
                                {{ form.samsung_exp|add_class:"form-control date-picker" }}
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                <button class="btn btn-fetch-previous" type="button" id="fetchPreviousSamsungExp"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-title="Fetch previous Samsung Expiration Date value">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Please provide a valid samsung exp.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-6">
                    <label for="{{ form.spv.id_for_label }}">SPV:</label>
                    {{ form.spv|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please select a valid SPV.
                    </div>
                </div>
                <div class="col-md-6">
                    {{ form.NIP.label_tag }}
                    {{ form.NIP|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid NIP.
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <div class="col">
                    <label for="{{ form.notes.id_for_label }}">Hal-hal yang perlu diperhatikan:</label>
                    {{ form.notes|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please select a valid notes.
                    </div>
                </div>
            </div>

            {% if form.errors %}
            <div id="form-errors" data-errors="true" style="display: none;">
                {% for field in form %}
                {% if field.errors %}
                {% for error in field.errors %}
                <div data-field="{{ field.id_for_label }}" data-error="{{ error|escapejs }}"></div>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <button type="submit" class="btn btn-primary" id="submit-button">Save</button>
            <a href="{% url 'bast:bastrecord_list' %}" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>
<style>
    /* Date Picker Styles */
    .date-picker-wrapper {
        max-width: 300px;
        /* Adjust width as needed */
    }

    .date-picker-wrapper .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .date-picker-wrapper .input-group-text {
        background-color: #f8f9fa;
        border-left: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .date-picker-wrapper .input-group-text:hover {
        background-color: #e9ecef;
        color: #495057;
        border-color: #e6e9ec;
        box-shadow: none;
    }

    .input-group-text {
        cursor: pointer;
    }

    .input-group-text i {
        color: #6c757d;
    }

    /* Flatpickr theme overrides */
    .flatpickr-calendar {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        border: 1px solid rgba(0, 0, 0, 0.125) !important;
        font-family: inherit !important;
    }

    .flatpickr-day.selected,
    .flatpickr-day.selected:hover {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
    }

    .flatpickr-day.today {
        border-color: #0d6efd !important;
    }

    /* Button styles for fetch previous button */
    .btn-fetch-previous {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #e6e9ec;
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }

    .btn-fetch-previous:hover,
    .btn-fetch-previous:focus {
        background-color: #e9ecef;
        color: #495057;
        border-color: #e6e9ec;
        box-shadow: none;
    }

    /* Accordion clickable header hover effect */
    .card-header.clickable {
        transition: background-color 0.2s;
    }

    .card-header.clickable:hover {
        background-color: #e9ecef;
    }
</style>

<!-- Helper function for showing error messages in modal -->
<script>
    function showErrorModal(message) {
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const errorContent = document.getElementById('errorModalContent');
        errorContent.innerHTML = `<p>${message}</p>`;
        errorModal.show();
    }
</script>
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Form validation with Bootstrap 5 and error modal
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.needs-validation');
        if (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    const errorContent = document.getElementById('errorModalContent');
                    let errorHtml = '<p>Mohon perbaiki kesalahan berikut:</p><ul class="mb-0">';
                    // Find all invalid fields
                    const invalidFields = form.querySelectorAll(':invalid');
                    invalidFields.forEach(field => {
                        const fieldLabel = document.querySelector(`label[for="${field.id}"]`);
                        const labelText = fieldLabel ? fieldLabel.textContent.trim().replace(':', '') : field.name;
                        errorHtml += `<li><strong>${labelText}:</strong> ${field.validationMessage || 'Wajib diisi'}</li>`;
                    });
                    errorHtml += '</ul>';
                    errorContent.innerHTML = errorHtml;
                    errorModal.show();
                }
                form.classList.add('was-validated');
            }, false);
        }
    });

    // Initialize Flatpickr for datetime inputs
    document.addEventListener('DOMContentLoaded', function () {
        // Handle start and end datetime changes
        const startInput = document.getElementById('datetime_bast_start');
        const endInput = document.getElementById('datetime_bast_end');

        if (startInput && endInput) {
            startInput.addEventListener('change', function () {
                if (this.value) {
                    endInput.min = this.value;
                }
            });
        }

        // Setup all date and datetime pickers
        const pickerConfigs = [
            { id: '{{ form.date.id_for_label }}' },
            { id: '{{ form.poco_exp.id_for_label }}' },
            { id: '{{ form.samsung_exp.id_for_label }}' },
            { id: 'datetime_bast_start', pickerClass: 'datetime-picker' },
            { id: 'datetime_bast_end', pickerClass: 'datetime-picker' }
        ];

        pickerConfigs.forEach(config => {
            setupCalendarIcon(config.id, config.pickerClass);
        });
    });
</script>
<script>

    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Helper for BAST ID suffix
    function getBastSuffix(waktuDinasValue) {
        switch (waktuDinasValue) {
            case 'Dini Hari':
                return '1D';
            case 'Pagi':
                return '2P';
            case 'Siang':
                return '3S';
            case 'Malam':
                return '4M';
            default:
                return '';
        }
    }

    // change bast_id and waktu_pelaksanaan value based on date_input and waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const bastIdInput = document.getElementById('{{ form.bast_id.id_for_label }}');
        // Set initial value
        bastIdInput.value = "BAST-" + dateInput.value + "-" + getBastSuffix(waktuDinasSelect.value);

        function updateBastId() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            bastIdInput.value = "BAST-" + dateValue + "-" + getBastSuffix(waktuDinasValue);
            const waktuPelaksanaanSelect = document.getElementById('{{ form.waktu_pelaksanaan.id_for_label }}');
            switch (waktuDinasValue) {
                case 'Pagi':
                    waktuPelaksanaanSelect.selectedIndex = 1;
                    break;
                case 'Siang':
                    waktuPelaksanaanSelect.selectedIndex = 2;
                    break;
                case 'Malam':
                    waktuPelaksanaanSelect.selectedIndex = 3;
                    break;
                case 'Dini Hari':
                    waktuPelaksanaanSelect.selectedIndex = 4;
                    break;
            }
        }

        dateInput.addEventListener('change', updateBastId);
        waktuDinasSelect.addEventListener('change', updateBastId);
    });

    // Fetch data and fill events
    document.getElementById('fetch_bast').addEventListener('click', function () {
        const startDatetime = document.getElementById('datetime_bast_start').value.replace('T', ' ');
        const endDatetime = document.getElementById('datetime_bast_end').value.replace('T', ' ');
        const url = `{% url 'bast:fetch_data' 'start_datetime' 'end_datetime' %}`
            .replace('start_datetime', encodeURIComponent(startDatetime))
            .replace('end_datetime', encodeURIComponent(endDatetime));

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const bastInput = document.querySelector('[name="{{ form.events.name }}"]');
                bastInput.value = data.csv;

                // Populate the table with fetched data
                const tableBody = document.getElementById('fetched-data-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.entries(row).forEach(([key, cell]) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        if (['MMI', 'Dis. PGN', 'Dis. PGR'].includes(key)) {
                            td.contentEditable = true;
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Expand the accordion if not already expanded
                const fetchedDataSection = document.getElementById('fetchedDataSection');
                const accordionButton = document.querySelector('[data-bs-target="#fetchedDataSection"]');
                if (fetchedDataSection && accordionButton && !fetchedDataSection.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(fetchedDataSection, {
                        toggle: true
                    });
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    });

    // populate the table with members from the selected kelompok
    document.addEventListener('DOMContentLoaded', function () {
        const kelompokSelect = document.getElementById('{{ form.kelompok.id_for_label }}');
        const tableBody = document.getElementById('member-data-table').querySelector('tbody');
        const existingMembers = `{{ existing_member_data|safe }}`;

        function updateMembers() {
            const selectedKelompok = kelompokSelect.value;
            fetch(`/bast/api/get_member_data/${selectedKelompok}/`)
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = '';
                    data.member_data.forEach((name, index) => {
                        const tr = document.createElement('tr');
                        let keterangan = 'Hadir';
                        if (existingMembers) {
                            const existingMembersArray = JSON.parse(existingMembers);
                            keterangan = existingMembersArray[index].keterangan;
                        }
                        tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${name}</td>
                            <td contentEditable=true>${keterangan}</td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // Trigger convertMemberTableToJSON after filling the column with "Hadir"
                    convertMemberTableToJSON();
                })
                .catch(error => console.error('Error fetching members:', error));
        }

        kelompokSelect.addEventListener('change', updateMembers);
        updateMembers();
    });

    // set the datetime_bast_start and datetime_bast_end default value to be dependent on the waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const datetimeBastStart = document.getElementById('datetime_bast_start');
        const datetimeBastEnd = document.getElementById('datetime_bast_end');

        function updateDatetime() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            let startDatetime, endDatetime;

            const prevDay = new Date(dateValue);
            prevDay.setDate(prevDay.getDate() - 1);
            const prevDayValue = prevDay.toISOString().split('T')[0];

            switch (waktuDinasValue[0]) {
                case 'P':
                    startDatetime = `${dateValue} 01:00:00`;
                    endDatetime = `${dateValue} 07:00:00`;
                    break;
                case 'S':
                    startDatetime = `${dateValue} 07:00:00`;
                    endDatetime = `${dateValue} 13:00:00`;
                    break;
                case 'M':
                    startDatetime = `${dateValue} 13:00:00`;
                    endDatetime = `${dateValue} 19:00:00`;
                    break;
                case 'D':
                    startDatetime = `${prevDayValue} 19:00:00`;
                    endDatetime = `${dateValue} 01:30:00`;
                    break;
            }

            datetimeBastStart.value = startDatetime;
            datetimeBastEnd.value = endDatetime;
        }

        dateInput.addEventListener('change', updateDatetime);
        waktuDinasSelect.addEventListener('change', updateDatetime);
        updateDatetime()

        function updateDatetimeBastStart() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            bastIdInput.value = dateValue + "-" + waktuDinasValue;
        }
    });

    // Set NIP's value based on the selected spv
    document.addEventListener('DOMContentLoaded', function () {
        const spvSelect = document.getElementById('{{ form.spv.id_for_label }}');
        const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');

        function updateNip() {
            const selectedSpv = spvSelect.value;
            const selectedSpvText = spvSelect.options[spvSelect.selectedIndex].text;

            // Only proceed if an SPV is actually selected (not the default empty option)
            if (!selectedSpv) {
                nipInput.value = '';
                return;
            }

            fetch(`/bast/api/get_nip/${selectedSpv}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Gagal mengambil data dari server');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.nip) {
                        nipInput.value = data.nip;
                    } else {
                        nipInput.value = '';
                        // Show modal for empty NIP
                        const emptyNipModal = new bootstrap.Modal(document.getElementById('emptyNipModal'));
                        const modalBody = document.getElementById('emptyNipModalBody');
                        modalBody.innerHTML = `
                            <p>Operator <strong>${selectedSpvText}</strong> belum memiliki NIP yang terdaftar.</p>
                            <p>Silakan tambahkan NIP melalui halaman <a href="{% url 'core:operator_list' %}" class="alert-link">Manajemen Operator</a>.</p>
                        `;
                        emptyNipModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching NIP:', error);
                    // Only show error modal if an SPV is selected
                    if (spvSelect.value) {
                        showErrorModal('Gagal mengambil data NIP: ' + (error.message || 'Terjadi kesalahan'));
                    }
                });
        }

        spvSelect.addEventListener('change', updateNip);
        updateNip();
    });

    // Convert table to CSV and put it in events form
    function convertTableToCSV() {
        const table = document.getElementById('fetched-data-table');
        let csv = [];
        let headers = [];
        const headerCells = table.querySelectorAll('thead th');
        headerCells.forEach(th => {
            const thText = th.childNodes[0].textContent.trim(); // Get the text content without the span and icons
            headers.push(thText);
        });
        csv.push(headers.join(','));

        for (let rowIndex = 1; rowIndex < table.rows.length; rowIndex++) { // Start from 1 to skip the header row
            let row = table.rows[rowIndex];
            let rowData = [];
            for (let cell of row.cells) {
                let cellText = cell.textContent;
                if (rowIndex !== 0 && (cell.cellIndex === 8 || cell.cellIndex === 9) && !cellText.startsWith('"')) { // Assuming "Region" is the 9th column (index 8) and "MMI" is the 10th column (index 9)
                    cellText = `"${cellText}"`;
                }
                // Omit cells with tooltips
                if (!cell.querySelector('.fas.fa-info-circle')) {
                    rowData.push(cellText);
                }
            }
            csv.push(rowData.join(','));
        }
        const csvString = csv.join('\n');
        const bastInput = document.querySelector('[name="{{ form.events.name }}"]');
        bastInput.value = csvString;
    }

    // Convert member table to JSON and put it in member form in real-time
    function convertMemberTableToJSON() {
        const table = document.getElementById('member-data-table');
        let json = [];
        for (let rowIndex = 1; rowIndex < table.rows.length; rowIndex++) { // Start from 1 to skip the header row
            let row = table.rows[rowIndex];
            let rowData = {};
            rowData['nama'] = row.cells[1].textContent; // Assuming "Nama" is the 2nd column (index 1)
            rowData['keterangan'] = row.cells[2].textContent; // Assuming "Keterangan" is the 3rd column (index 2)
            json.push(rowData);
        }
        const jsonString = JSON.stringify(json);
        const memberInput = document.getElementById('{{ form.member.id_for_label }}');
        memberInput.value = jsonString;
    }

    // Trigger convertMemberTableToJSON on table cell input
    document.addEventListener('input', function (event) {
        if (event.target.closest('#member-data-table td[contenteditable="true"]')) {
            convertMemberTableToJSON();
        }
    });

    // Trigger calculateSelisihPGN, calculateSelisihPGR, and convertTableToCSV on input in fetched-data-table
    document.addEventListener('input', function (event) {
        if (event.target.closest('#fetched-data-table td[contenteditable="true"]')) {
            calculateSelisihPGN();
            calculateSelisihPGR();
            convertTableToCSV();
        }
    });

    // Populate table with existing data when editing the form
    document.addEventListener('DOMContentLoaded', function () {
        const existingDataCSV = `{{ existing_data|safe }}`;
        if (existingDataCSV) {
            const rows = existingDataCSV.split('\n');
            const tableBody = document.getElementById('fetched-data-table').querySelector('tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                rows.forEach((row, rowIndex) => {
                    // Skip the header row (rowIndex === 0)
                    if (rowIndex === 0) return; // or continue;

                    const tr = document.createElement('tr');
                    const cells = parseCSV(row);
                    cells.forEach((cell, cellIndex) => {
                        const td = document.createElement('td');
                        if (cell) {
                            td.textContent = cell;
                        }

                        const th = tableBody.parentElement.querySelector('thead').querySelector('th:nth-child(' + (cellIndex + 1) + ')');
                        if (th) {
                            const thText = th.childNodes[0].textContent.trim(); // Get the text content without the span and icons
                            if (['MMI', 'Dis. PGN', 'Dis. PGR'].includes(thText)) {
                                td.contentEditable = true;
                            }
                        }

                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            } else {
                console.error("Table body not found!");
            }
        }
    });

    // Parse CSV string into an array of arrays
    function parseCSV(csvString) {
        const result = [];
        let inQuotes = false;
        let currentField = '';

        for (let i = 0; i < csvString.length; i++) {
            const char = csvString[i];

            if (char === '"') {
                if (inQuotes && i + 1 < csvString.length && csvString[i + 1] === '"') {
                    // Escaped double quote
                    currentField += '"';
                    i++; // Skip the next quote
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(currentField.trim());
                currentField = '';
            } else {
                currentField += char;
            }
        }
        result.push(currentField.trim()); // Add the last field
        return result;
    }

    // Function to calculate the difference between Dis. PGN and OT (UTC)
    function calculateSelisihPGN() {
        const table = document.getElementById('fetched-data-table');
        for (let rowIndex = 1; rowIndex < table.rows.length; rowIndex++) { // Start from 1 to skip the header row
            let row = table.rows[rowIndex];
            let otUTC = row.cells[2].textContent; // Assuming "OT (UTC)" is the 3rd column (index 2)
            let disPGN = row.cells[10].textContent; // Assuming "Dis. PGN" is the 11th column (index 10)
            let selisihPGNCell = row.cells[11]; // Assuming "Selisih PGN" is the 12th column (index 11)

            if (otUTC && disPGN) {
                let otUTCDate = new Date(`1970-01-01T${otUTC}Z`).getTime();
                let disPGNTime = disPGN.includes(':') ? disPGN : `${disPGN}:00`; // Add seconds if not present
                let disPGNDate = new Date(`1970-01-01T${disPGNTime}Z`).getTime();
                let selisihPGN = (disPGNDate - otUTCDate) / 1000; // Difference in seconds

                let hours = Math.floor(selisihPGN / 3600);
                let minutes = Math.floor((selisihPGN % 3600) / 60);
                let seconds = Math.floor(selisihPGN % 60);

                if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                    selisihPGNCell.textContent = "";
                } else {
                    selisihPGNCell.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }
            else {
                selisihPGNCell.textContent = "";
            }
        }
    }

    // Function to calculate the difference between Dis. PGR and OT (UTC)
    function calculateSelisihPGR() {
        const table = document.getElementById('fetched-data-table');
        for (let rowIndex = 1; rowIndex < table.rows.length; rowIndex++) { // Start from 1 to skip the header row
            let row = table.rows[rowIndex];
            let otUTC = row.cells[2].textContent; // Assuming "OT (UTC)" is the 3rd column (index 2)
            let disPGR = row.cells[12].textContent; // Assuming "Dis. PGR" is the 13th column (index 12)
            let selisihPGRCell = row.cells[13]; // Assuming "Selisih PGR" is the 14th column (index 13)

            if (otUTC && disPGR) {
                let otUTCDate = new Date(`1970-01-01T${otUTC}Z`).getTime();
                let disPGRTime = disPGR.includes(':') ? disPGR : `${disPGR}:00`; // Add seconds if not present
                let disPGRDate = new Date(`1970-01-01T${disPGRTime}Z`).getTime();
                let selisihPGR = (disPGRDate - otUTCDate) / 1000; // Difference in seconds

                let hours = Math.floor(selisihPGR / 3600);
                let minutes = Math.floor((selisihPGR % 3600) / 60);
                let seconds = Math.floor(selisihPGR % 60);

                if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                    selisihPGRCell.textContent = "";
                } else {
                    selisihPGRCell.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }
            else {
                selisihPGRCell.textContent = "";
            }
        }
    }

    // Trigger calculateSelisihPGN and calculateSelisihPGR when the table cells are edited
    document.addEventListener('blur', function (event) {
        if (event.target.closest('#fetched-data-table td[contenteditable="true"]')) {
            calculateSelisihPGN();
            calculateSelisihPGR();
            convertTableToCSV();
        }
    });

    // Autofill waktu_cs, count_gaps, count_spikes, and count_blanks based on bast_id
    document.addEventListener('DOMContentLoaded', function () {
        const bastIdInput = document.getElementById('{{ form.bast_id.id_for_label }}');
        const countGapsInput = document.getElementById('{{ form.count_gaps.id_for_label }}');
        const countSpikesInput = document.getElementById('{{ form.count_spikes.id_for_label }}');
        const countBlanksInput = document.getElementById('{{ form.count_blanks.id_for_label }}');
        const shiftSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuCsInput = document.getElementById('{{ form.waktu_cs.id_for_label }}');

        function simplifyCsId(csId) {
            // Replace -1D, -2P, -3S, -4M with -D, -P, -S, -M
            return csId.replace(/-(\\d)([DPSM])$/, '-$2');
        }

        function autofillCounts() {
            const bastId = bastIdInput.value;
            let csId = bastId.replace('BAST', 'CS');
            csId = simplifyCsId(csId);
            fetch(`/bast/api/get_cs_data/${csId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.count_gaps !== undefined) {
                        countGapsInput.value = data.count_gaps;
                    }
                    if (data.count_spikes !== undefined) {
                        countSpikesInput.value = data.count_spikes;
                    }
                    if (data.count_blanks !== undefined) {
                        countBlanksInput.value = data.count_blanks;
                    }
                    if (data.waktu_cs !== undefined) {
                        waktuCsInput.value = data.waktu_cs;
                    }
                })
                .catch(error => console.error('Error fetching CS data:', error));
        }

        // Create a new event to trigger the change event
        function triggerChangeEvent(element) {
            const event = new Event('change', { bubbles: true });
            element.dispatchEvent(event);
        }

        function handleDateOrShiftChange() {
            triggerChangeEvent(bastIdInput);
        }

        shiftSelect.addEventListener('change', handleDateOrShiftChange);
        dateInput.addEventListener('change', handleDateOrShiftChange);
        bastIdInput.addEventListener('change', autofillCounts);
        
        // Call autofillCounts after setting initial BAST ID
        if (bastIdInput.value) {
            autofillCounts();
        }
    });
    // --- Fetch Previous Members Button Logic ---
    document.getElementById('fetch-prev-members-btn').addEventListener('click', function () {
        fetch('/bast/api/get_previous_members/')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // Get all existing rows in the table
                const rows = document.querySelectorAll('#member-data-table tbody tr');
                let updated = false;

                // For each row, update only the Keterangan column if there's matching data
                rows.forEach((row, index) => {
                    const namaCell = row.cells[1]; // Nama is in the second cell (index 1)
                    const keteranganCell = row.cells[2]; // Keterangan is in the third cell (index 2)

                    // Find matching member data by name (case insensitive)
                    const memberData = data.find(m =>
                        m.nama && namaCell.textContent.trim().toLowerCase() === m.nama.trim().toLowerCase()
                    );

                    // Only update Keterangan if we found a match and it has a value
                    if (memberData && memberData.keterangan) {
                        keteranganCell.textContent = memberData.keterangan;
                        updated = true;
                    }
                });

                // If any updates were made, trigger the conversion to update the hidden field
                if (updated) {
                    convertMemberTableToJSON();
                } else {
                    showErrorModal('Hanya bisa mengambil data jika kelompok yang dipilih sama dengan kelompok pada data sebelumnya');
                }
            })
            .catch(error => {
                console.error('Error fetching previous members:', error);
                showErrorModal('Gagal mengambil data anggota sebelumnya: ' + error.message);
            });
    });
    // --- End Fetch Previous Members ---
    // --- Fetch Previous Poco Exp Button Logic ---
    document.addEventListener('DOMContentLoaded', function () {
        // Poco Expiration Date
        const fetchPocoButton = document.getElementById('fetchPreviousPocoExp');
        const pocoExpInput = document.getElementById('{{ form.poco_exp.id_for_label }}');

        if (fetchPocoButton && pocoExpInput) {
            fetchPocoButton.addEventListener('click', function () {
                fetch('{% url "bast:get_previous_poco_exp" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.poco_exp !== null && data.poco_exp !== undefined) {
                            pocoExpInput.value = data.poco_exp;
                            // Trigger change event in case there are any listeners
                            const event = new Event('change');
                            pocoExpInput.dispatchEvent(event);
                        } else {
                            showErrorModal('No previous Poco Expiration Date found');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching previous Poco Expiration Date:', error);
                        showErrorModal('Error fetching previous Poco Expiration Date');
                    });
            });
        }

        // Samsung Expiration Date
        const fetchSamsungButton = document.getElementById('fetchPreviousSamsungExp');
        const samsungExpInput = document.getElementById('{{ form.samsung_exp.id_for_label }}');

        if (fetchSamsungButton && samsungExpInput) {
            fetchSamsungButton.addEventListener('click', function () {
                fetch('{% url "bast:get_previous_samsung_exp" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.samsung_exp !== null && data.samsung_exp !== undefined) {
                            samsungExpInput.value = data.samsung_exp;
                            // Trigger change event in case there are any listeners
                            const event = new Event('change');
                            samsungExpInput.dispatchEvent(event);
                        } else {
                            showErrorModal('No previous Samsung Expiration Date found');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching previous Samsung Expiration Date:', error);
                        showErrorModal('Error fetching previous Samsung Expiration Date');
                    });
            });
        }

        // Pulsa Poco
        const fetchPulsaPocoButton = document.getElementById('fetchPreviousPulsaPoco');
        const pulsaPocoInput = document.getElementById('{{ form.pulsa_poco.id_for_label }}');

        if (fetchPulsaPocoButton && pulsaPocoInput) {
            fetchPulsaPocoButton.addEventListener('click', function () {
                fetch('{% url "bast:get_previous_pulsa_poco" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.pulsa_poco !== null && data.pulsa_poco !== undefined) {
                            pulsaPocoInput.value = data.pulsa_poco;
                            // Trigger change event in case there are any listeners
                            const event = new Event('change');
                            pulsaPocoInput.dispatchEvent(event);
                        } else {
                            showErrorModal('No previous Pulsa Poco value found');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching previous Pulsa Poco value:', error);
                        showErrorModal('Error fetching previous Pulsa Poco value');
                    });
            });
        }
    });
    // --- End Fetch Previous Poco Exp ---

    // Handle form validation errors
    document.addEventListener('DOMContentLoaded', function () {
        const formErrors = document.getElementById('form-errors');
        if (formErrors && formErrors.dataset.errors === 'true') {
            // Get the error modal element
            const errorModalElement = document.getElementById('errorModal');
            if (errorModalElement) {
                // Initialize the Bootstrap 5 modal
                const errorModal = new bootstrap.Modal(errorModalElement, {
                    backdrop: true, // Enable backdrop click to close
                    keyboard: true  // Enable ESC key to close
                });

                const errorContent = document.getElementById('errorModalContent');

                if (errorContent) {
                    let errorHtml = '<p>Silakan perbaiki kesalahan berikut:</p><ul class="mb-0">';

                    // Get all error elements
                    const errorElements = formErrors.querySelectorAll('[data-field][data-error]');
                    if (errorElements.length > 0) {
                        errorElements.forEach(el => {
                            const fieldId = el.dataset.field;
                            const errorMsg = el.dataset.error;
                            const fieldLabel = document.querySelector(`label[for="${fieldId}"]`);
                            const labelText = fieldLabel ? fieldLabel.textContent.trim().replace(':', '') : fieldId;
                            errorHtml += `<li><strong>${labelText}:</strong> ${errorMsg}</li>`;
                        });
                    } else {
                        // Fallback if no specific field errors found
                        errorHtml += '<li>Terjadi kesalahan saat memproses formulir.</li>';
                    }

                    errorHtml += '</ul>';
                    errorContent.innerHTML = errorHtml;

                    // Show the modal
                    errorModal.show();

                    // Manually handle close button click
                    const closeButtons = errorModalElement.querySelectorAll('[data-bs-dismiss="modal"]');
                    closeButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            errorModal.hide();
                        });
                    });
                }
            }
        }
    });

    // Large Table Modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        const openTableModalBtn = document.getElementById('openTableModal');
        const largeTableModal = document.getElementById('largeTableModal');
        const largeTableModalTable = document.getElementById('large-table-modal-table');
        const refreshTableDataBtn = document.getElementById('refreshTableData');
        const originalTable = document.getElementById('fetched-data-table');
        
        // Initialize Bootstrap modal
        const bsModal = new bootstrap.Modal(largeTableModal);
        
        // Function to sync data from original table to modal table
        function syncDataToModal() {
            const originalTableBody = originalTable.querySelector('tbody');
            const modalTableBody = largeTableModalTable.querySelector('tbody');
            
            // Clear modal table body
            modalTableBody.innerHTML = '';
            
            // Copy each row from original table to modal table
            Array.from(originalTableBody.rows).forEach(row => {
                const newRow = document.createElement('tr');
                
                Array.from(row.cells).forEach((cell, index) => {
                    const newCell = document.createElement('td');
                    newCell.textContent = cell.textContent;
                    
                    // Make editable columns same as original (MMI, Dis. PGN, Dis. PGR)
                    if (cell.contentEditable === 'true') {
                        newCell.contentEditable = true;
                        newCell.style.backgroundColor = '#fff3cd'; // Light yellow to indicate editable
                        newCell.style.cursor = 'text';
                    }
                    
                    newRow.appendChild(newCell);
                });
                
                modalTableBody.appendChild(newRow);
            });
            
            // Initialize tooltips for the modal table
            var tooltipTriggerList = [].slice.call(largeTableModalTable.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Function to sync data from modal table back to original table
        function syncDataFromModal() {
            const originalTableBody = originalTable.querySelector('tbody');
            const modalTableBody = largeTableModalTable.querySelector('tbody');
            
            // Update each row in original table with data from modal table
            Array.from(modalTableBody.rows).forEach((modalRow, rowIndex) => {
                const originalRow = originalTableBody.rows[rowIndex];
                if (originalRow) {
                    Array.from(modalRow.cells).forEach((modalCell, cellIndex) => {
                        const originalCell = originalRow.cells[cellIndex];
                        if (originalCell && modalCell.contentEditable === 'true') {
                            originalCell.textContent = modalCell.textContent;
                        }
                    });
                }
            });
            
            // Trigger the CSV conversion to update the form
            convertTableToCSV();
        }
        
        // Open modal button click handler
        openTableModalBtn.addEventListener('click', function() {
            // Check if there's data in the original table
            const originalTableBody = originalTable.querySelector('tbody');
            if (originalTableBody.rows.length === 0) {
                alert('No data available. Please fetch data first.');
                return;
            }
            
            // Sync data to modal and show it
            syncDataToModal();
            bsModal.show();
        });
        
        // Refresh data button click handler
        refreshTableDataBtn.addEventListener('click', function() {
            syncDataToModal();
        });
        
        // Handle modal close - sync data back to original table
        largeTableModal.addEventListener('hidden.bs.modal', function() {
            syncDataFromModal();
        });
        
        // Handle input events in modal table (for editable cells)
        largeTableModalTable.addEventListener('input', function(event) {
            if (event.target.contentEditable === 'true') {
                // Calculate selisih values if needed (similar to original table logic)
                const cell = event.target;
                const row = cell.parentElement;
                const cellIndex = cell.cellIndex;
                
                // Calculate Selisih PGN (column 11) when Dis. PGN (column 10) is edited
                if (cellIndex === 10) { // Dis. PGN column
                    const otCell = row.cells[2]; // OT (UTC) column
                    const selisihPgnCell = row.cells[11]; // Selisih PGN column
                    
                    if (otCell && selisihPgnCell && cell.textContent.trim() !== '') {
                        const otTime = new Date('1970-01-01T' + otCell.textContent + 'Z');
                        const disPgnTime = new Date('1970-01-01T' + cell.textContent + 'Z');
                        
                        if (!isNaN(otTime) && !isNaN(disPgnTime)) {
                            const diffInSeconds = (disPgnTime - otTime) / 1000;
                            const minutes = Math.floor(Math.abs(diffInSeconds) / 60);
                            const seconds = Math.abs(diffInSeconds) % 60;
                            const sign = diffInSeconds >= 0 ? '' : '-';
                            selisihPgnCell.textContent = `${sign}${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                }
                
                // Calculate Selisih PGR (column 13) when Dis. PGR (column 12) is edited
                if (cellIndex === 12) { // Dis. PGR column
                    const otCell = row.cells[2]; // OT (UTC) column
                    const selisihPgrCell = row.cells[13]; // Selisih PGR column
                    
                    if (otCell && selisihPgrCell && cell.textContent.trim() !== '') {
                        const otTime = new Date('1970-01-01T' + otCell.textContent + 'Z');
                        const disPgrTime = new Date('1970-01-01T' + cell.textContent + 'Z');
                        
                        if (!isNaN(otTime) && !isNaN(disPgrTime)) {
                            const diffInSeconds = (disPgrTime - otTime) / 1000;
                            const minutes = Math.floor(Math.abs(diffInSeconds) / 60);
                            const seconds = Math.abs(diffInSeconds) % 60;
                            const sign = diffInSeconds >= 0 ? '' : '-';
                            selisihPgrCell.textContent = `${sign}${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                }
            }
        });
    });
</script>

<!-- Large Table Modal -->
<div class="modal fade" id="largeTableModal" tabindex="-1" aria-labelledby="largeTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="largeTableModalLabel">
                    <i class="fas fa-table"></i> Earthquake Events Data - Larger View
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instructions:</strong> You can edit the MMI, Dis. PGN, and Dis. PGR columns by clicking on the cells. Changes will be automatically saved when you close this modal.
                </div>
                <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-bordered table-striped table-hover mb-0" id="large-table-modal-table" style="min-width: 1100px;">
                        <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="width: 40px;">No</th>
                                <th>Date</th>
                                <th>OT (UTC)</th>
                                <th>Lat</th>
                                <th>Long</th>
                                <th>D(Km)</th>
                                <th>Mag</th>
                                <th>TypeMag</th>
                                <th>Region</th>
                                <th>MMI
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Contoh: dirasakan di Kolaka Timur III MMI">
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                </th>
                                <th>Dis. PGN (UTC)
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Waktu diseminasi oleh PGN dalam UTC. Contoh: 20:25:03">
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                </th>
                                <th>Selisih PGN</th>
                                <th>Dis. PGR (UTC)
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Waktu diseminasi oleh PGR dalam UTC. Contoh: 20:25:03">
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                </th>
                                <th>Selisih PGR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" id="refreshTableData">
                    <i class="fas fa-sync"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}