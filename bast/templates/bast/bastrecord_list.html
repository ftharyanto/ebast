{% extends 'core/base.html' %}
{% load static %} {# Add static load if not present, needed for icons/styles potentially #}
{% block title %}BAST Records{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">BAST Records</h1>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end align-items-center mb-4">
                    <a href="{% url 'bast:bastrecord_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Create New Record
                    </a>
                </div>

                <div class="card shadow-sm mb-4">
                    <div
                        class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="input-group input-group-sm me-2" style="min-width: 250px;">
                            <button type="button" class="btn btn-sm btn-primary me-2"
                                onclick="window.location.href=`{% url 'bast:bast_all_records' %}`">
                                <i class="fas fa-list me-1"></i> All Records
                            </button>
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="globalSearch" class="form-control"
                                placeholder="Search in all columns...">
                            <button id="clearSearch" class="btn btn-outline-secondary" type="button"
                                title="Clear search" style="border-color: #dee2e6;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0 d-flex flex-column" style="height: calc(100vh - 200px);">
                        <div style="flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
                            <div id="tabulator-table" class="loading" style="flex: 1; min-height: 0; min-width: 100%; position: relative;">
                                <div class="loader-container" style='position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;'>
                                    <div class="loader" style='display:inline-block; border:4px solid #0d6efd; border-radius:10px; background:#fff; font-weight:bold; font-size:16px; color:#0d6efd; padding:12px 24px; border-width: 2px; box-shadow: 0 2px 4px rgba(0, 109, 237, 0.2);'>
                                        Loading Data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize tooltips (assuming Bootstrap 5)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            // Ensure bootstrap is loaded, might need adjustment based on your base template
            if (typeof bootstrap !== 'undefined') {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });

        // Add event listeners for global search
        var searchInput = document.getElementById('globalSearch');
        var clearSearchBtn = document.getElementById('clearSearch');
        var searchTimeout;
        
        // Search on input with debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                var searchValue = searchInput.value;
                if (searchValue === '') {
                    table.clearFilter();
                } else {
                    table.setFilter(function(data) {
                        return table.options.globalSearch(data, searchValue);
                    });
                }
            }, 300);
        });
        
        // Clear search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            table.clearFilter();
        });
        
        // Search on Enter key
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                var searchValue = searchInput.value;
                if (searchValue === '') {
                    table.clearFilter();
                } else {
                    table.setFilter(function(data) {
                        return table.options.globalSearch(data, searchValue);
                    });
                }
            } else if (e.key === 'Escape') {
                searchInput.value = '';
                table.clearFilter();
            }
        });

        // Initialize all delete modals
        const deleteModals = document.querySelectorAll('.modal');
        deleteModals.forEach(modal => {
            new bootstrap.Modal(modal);
        });

        // Handle delete form submission
        const deleteButtons = document.querySelectorAll('.delete-button');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function () {
                const modal = bootstrap.Modal.getInstance(button.closest('.modal'));
                if (modal) {
                    modal.show();
                }
            });
        });

        // Initialize Tabulator
        var table = new Tabulator("#tabulator-table", {

            // Disable header filters
            headerFilterLiveFilter: false,
            // Update deprecated configuration options
            layout: "fitColumns", // Make table fill available space
            responsiveLayout: false,
            pagination: "remote",
            paginationSize: 10,
            movableColumns: true,
            dataLoader: false,
            addRowPos: "top",
            history: true,
            paginationCounter: "rows",
            ajaxURL: `{% url 'bast:bastrecord_list_api' 0 %}`,
            ajaxConfig: "GET",
            ajaxRequesting: function(url, params) {
                // Show loading state
                document.getElementById('tabulator-table').classList.add('loading');
            },
            ajaxResponse: function(url, params, response) {
                // Hide loading state
                document.getElementById('tabulator-table').classList.remove('loading');
                console.log('AJAX Response received. Record count:', response ? response.length : 0);
                return response;
            },
            ajaxError: function(xhr, status, error) {
                // Hide loading state on error
                document.getElementById('tabulator-table').classList.remove('loading');
                console.error('AJAX Error:', error);
            },
            ajaxContentType: "json",
            
            // Function to perform global search
            globalSearch: function(data, searchValue) {
                // Check each property of the row
                for (var key in data) {
                    // Skip internal Tabulator fields and functions
                    if (typeof data[key] === 'function' || key === 'id' || key === '_row' || key === 'table') {
                        continue;
                    }
                    
                    // Get the value and convert to string
                    var value = data[key];
                    if (value === null || value === undefined) {
                        continue;
                    }
                    
                    // Convert to string and check if it contains the search term
                    var stringValue = String(value).toLowerCase();
                    if (stringValue.includes(searchValue.toLowerCase())) {
                        return true;
                    }
                }
                return false;
            },
            
            // Function to perform global search
            globalSearch: function(data, searchValue) {
                // Check each property of the row
                for (var key in data) {
                    // Skip internal Tabulator fields and functions
                    if (typeof data[key] === 'function' || !(key === 'bast_id' || key === 'spv_name')) {
                        continue;
                    }
                    
                    // Get the value and convert to string
                    var value = data[key];
                    if (value === null || value === undefined) {
                        continue;
                    }
                    
                    // Convert to string and check if it contains the search term
                    var stringValue = String(value).toLowerCase();
                    if (stringValue.includes(searchValue.toLowerCase())) {
                        return true;
                    }
                }
                return false;
            },
            ajaxResponse: function (url, params, response) {
                console.log('AJAX Response received. Record count:', response ? response.length : 0);
                if (response && response.length > 0) {
                    console.log('First record:', response[0]);
                }
                document.getElementById('tabulator-table').classList.remove('loading');
                return response;
            },
            ajaxError: function (xhr, status, error) {
                console.error('AJAX Error:', status, error);
                console.error('Response text:', xhr.responseText);
                document.getElementById('tabulator-table').classList.remove('loading');
                return [];
            },
            dataLoaded: function (data) {
                console.log('Data loaded into Tabulator. Row count:', data.length);
                if (data.length > 0) {
                    console.log('First row data:', data[0]);
                }
                updateStatusBar();
            },
            dataLoadError: function (error) {
                console.error('Data load error:', error);
            },
            tableBuilt: function () {
                const table = this;

                // Pagination event handlers
                document.getElementById('first-page').addEventListener('click', () => table.setPage(1));
                document.getElementById('prev-page').addEventListener('click', () => table.previousPage());
                document.getElementById('next-page').addEventListener('click', () => table.nextPage());
                document.getElementById('last-page').addEventListener('click', () => table.setPage('last'));

                // Page size change handler
                document.getElementById('page-size').addEventListener('change', function () {
                    table.setPageSize(parseInt(this.value));
                    table.setPage(1);
                });

                // Update status when data changes
                table.on([
                    'pageLoaded',
                    'pageSizeChanged',
                    'dataFiltered',
                    'dataSorted',
                ], updateStatusBar);

                // Initial status update
                updateStatusBar();
                const tableElement = document.querySelector('.tabulator-tableholder');
                const scrollLeftBtn = document.getElementById('scroll-left');
                const scrollRightBtn = document.getElementById('scroll-right');

                // Update button states
                const updateButtonStates = () => {
                    scrollLeftBtn.disabled = tableElement.scrollLeft === 0;
                    scrollRightBtn.disabled = tableElement.scrollLeft >= (tableElement.scrollWidth - tableElement.clientWidth - 5);
                };

                // Scroll left
                scrollLeftBtn.addEventListener('click', () => {
                    tableElement.scrollBy({ left: -200, behavior: 'smooth' });
                    setTimeout(updateButtonStates, 300);
                });

                // Scroll right
                scrollRightBtn.addEventListener('click', () => {
                    tableElement.scrollBy({ left: 200, behavior: 'smooth' });
                    setTimeout(updateButtonStates, 300);
                });

                // Update on scroll
                tableElement.addEventListener('scroll', updateButtonStates);

                // Initial state
                updateButtonStates();
            },
            columns: [
                {
                    title: "BAST ID",
                    field: "bast_id",
                    hozAlign: "center",
                    headerHozAlign: "center",
                    formatter: function (cell, formatterParams, onRendered) {
                        const value = cell.getValue();
                        return value || '';
                    }
                },
                {
                    title: "SPV",
                    field: "spv_name",
                    headerHozAlign: "center",
                    formatter: function (cell) {
                        return cell.getValue() || '';
                    }
                },
                {
                    title: "Actions",
                    headerHozAlign: "center",
                    formatter: function (cell, formatterParams, onRendered) {
                        const row = cell.getRow();
                        const id = row.getData().id;
                        const updateUrl = '{% url "bast:bastrecord_update" 0 %}'.replace('0', id);
                        const deleteUrl = '#deleteModal-id'.replace('id', id);
                        const exportExcelUrl = '{% url "bast:export_to_excel" 0 %}'.replace('0', id);
                        const exportPdfUrl = '{% url "bast:export_to_pdf" 0 %}'.replace('0', id);
                        return `
                            <div class="d-flex gap-2">
                                <a href="${updateUrl}"
                                    class="btn btn-sm btn-warning" data-bs-toggle="tooltip"
                                    title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger delete-button"
                                    data-bs-toggle="modal" data-bs-target="${deleteUrl}"
                                    data-bs-toggle="tooltip" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <a href="${exportExcelUrl}"
                                    class="btn btn-sm btn-light text-success" data-bs-toggle="tooltip"
                                    title="Export to Excel">
                                    <i class="fas fa-file-excel"></i>
                                </a>
                                <a href="${exportPdfUrl}"
                                    class="btn btn-sm btn-light text-danger" data-bs-toggle="tooltip"
                                    title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        `;
                    },
                    headerSort: false
                },
            ],
            ajaxRequesting: function (url, params) {
                console.log('AJAX Request:', url, params);
                // Show loading state
                document.getElementById('tabulator-table').classList.add('loading');
            },
            ajaxResponse: function (url, params, response) {
                console.log('AJAX Response:', url, response);
                // Hide loading state
                document.getElementById('tabulator-table').classList.remove('loading');
                return response;
            },
            ajaxError: function (xhr, textStatus, errorThrown) {
                console.error('AJAX Error:', textStatus, errorThrown);
                document.getElementById('tabulator-table').classList.remove('loading');
                return [];
            }
        });

    });
</script>
{% endblock %}