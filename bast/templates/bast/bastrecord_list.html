{% extends 'core/base.html' %}
{% load static %} {# Add static load if not present, needed for icons/styles potentially #}
{% block title %}BAST Records{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">BAST Records</h1>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-xl-12"> {# Make table wider #}
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        {% if request.GET.all == '1' %}
                        <form method="get" class="d-inline-block">
                            {% for key, value in request.GET.items %}
                                {% if key != 'all' %}<input type="hidden" name="{{ key }}" value="{{ value }}" />{% endif %}
                            {% endfor %}
                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-table me-1"></i> Show 10 Last Records
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% url 'bast:bastrecord_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> Create New Record
                        </a>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                        {% if not request.GET.all %}
                        <div class="d-flex align-items-center">
                            <label for="recordsPerPageTop" class="form-label me-2 mb-0 small">Show:</label>
                            <select id="recordsPerPageTop" class="form-select form-select-sm d-inline-block w-auto">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                            </select>
                            <span class="ms-1 small">entries</span>
                        </div>
                        {% else %}
                        <div id="tableInfo" class="small text-muted"></div>
                        {% endif %}
                        <div class="input-group input-group-sm w-auto">
                             <span class="input-group-text"><i class="fas fa-search"></i></span>
                             <input type="text" id="searchFilter" placeholder="Search ID or SPV..." class="form-control">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 table-layout-fixed" id="bastRecordTable"> {# Add table-layout-fixed #}
                                <thead class="table-light">
                                    <tr>
                                        <th onclick="sortTable(0)" class="table-pointer table-col-20">ID <span id="idSortArrow"></span></th>
                                        <th onclick="sortTable(1)" class="table-pointer table-col-40">SPV <span id="spvSortArrow"></span></th>
                                        <th class="table-col-20">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bastRecordTableBody">
                                    {% for record in bastrecords %}
                                    <tr>
                                        <td>{{ record.bast_id }}</td>
                                        <td>{{ record.spv.name }}</td>
                                        <td>
                                            <a href="{% url 'bast:bastrecord_update' record.pk %}" class="btn btn-sm btn-warning me-1" data-bs-toggle="tooltip" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{% url 'bast:bastrecord_delete_direct' record.pk %}" method="post" class="delete-form d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger delete-button me-1" data-bs-toggle="tooltip" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            <a href="{% url 'bast:export_to_excel' record.pk %}" class="btn btn-sm btn-light text-success me-1" data-bs-toggle="tooltip" title="Export to Excel">
                                                <i class="fas fa-file-excel"></i>
                                            </a>
                                            <a href="{% url 'bast:export_to_pdf' record.pk %}" class="btn btn-sm btn-light text-danger" data-bs-toggle="tooltip" title="Export to PDF">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">No BAST records found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- Entries Info -->
                            <div id="tableInfo" class="small text-muted"></div>
                            
                            <!-- Pagination and Actions -->
                            <div class="d-flex align-items-center">
                                {% if not request.GET.all %}
                                    <!-- Pagination -->
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination mb-0 me-2">
                                            <li class="page-item">
                                                <button id="prevPage" class="page-link"><i class="fas fa-angle-left"></i></button>
                                            </li>
                                            <li class="page-item">
                                                <span id="pageInfo" class="page-link"></span>
                                            </li>
                                            <li class="page-item">
                                                <button id="nextPage" class="page-link"><i class="fas fa-angle-right"></i></button>
                                            </li>
                                        </ul>
                                    </nav>

                                    <!-- Show All Button -->
                                    <form method="get" class="d-inline-block">
                                        {% for key, value in request.GET.items %}
                                            {% if key != 'all' %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}" />
                                            {% endif %}
                                        {% endfor %}
                                        <input type="hidden" name="all" value="1" />
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-list"></i> Show All Records
                                        </button>
                                    </form>
                                {% else %}
                                    <!-- Show Paged View Button -->
                                    <form method="get" class="d-inline-block">
                                        {% for key, value in request.GET.items %}
                                            {% if key != 'all' %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}" />
                                            {% endif %}
                                        {% endfor %}
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-table"></i> Show Paged View
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize tooltips (assuming Bootstrap 5)
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      // Ensure bootstrap is loaded, might need adjustment based on your base template
      if (typeof bootstrap !== 'undefined') {
          return new bootstrap.Tooltip(tooltipTriggerEl);
      }
    });

    // Delete confirmation
    const deleteForms = document.querySelectorAll('.delete-form');
    deleteForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            const confirmed = confirm('Are you sure you want to delete this item?');
            if (!confirmed) {
                event.preventDefault(); // Stop form submission
            }
        });
    });

    // --- Pagination, Filtering, Sorting Logic ---
    let currentPage = 1;
    const recordsPerPageSelect = document.getElementById("recordsPerPageTop");
    let recordsPerPage = recordsPerPageSelect ? parseInt(recordsPerPageSelect.value) : 1000; // Use 1000 as a large number when showing all
    const table = document.getElementById("bastRecordTable");
    const tbody = document.getElementById("bastRecordTableBody");
    // Store original data rows, exclude empty message row if present
    const originalRows = Array.from(tbody.querySelectorAll("tr:not(:has(td[colspan='3']))"));
    let currentRows = [...originalRows]; // Rows currently being displayed/filtered/sorted
    let totalPages = 1; // Default to 1 page when showing all
    
    if (recordsPerPageSelect) {
        totalPages = Math.ceil(currentRows.length / recordsPerPage);
    }
    // Initial sort: ID descending (column 0)
    let sortDirection = { 0: 'desc' };

    const pageInfoSpan = document.getElementById("pageInfo");
    const prevPageButton = document.getElementById("prevPage");
    const nextPageButton = document.getElementById("nextPage");
    const searchFilterInput = document.getElementById("searchFilter");
    const tableInfoDiv = document.getElementById("tableInfo");

    function displayPage(page) {
        currentPage = page;
        const start = (page - 1) * recordsPerPage;
        const end = start + recordsPerPage;

        // Hide all original rows first
        originalRows.forEach(row => row.style.display = 'none');

        // Show only rows for the current page from the *current* set (filtered/sorted)
        const pageRows = currentRows.slice(start, end);
        pageRows.forEach(row => row.style.display = ''); // Use default display (usually 'table-row')


        // Only update pagination controls if they exist
        if (pageInfoSpan) {
            totalPages = Math.ceil(currentRows.length / recordsPerPage); // Recalculate in case of filtering
            if (totalPages === 0) totalPages = 1; // Avoid Page X of 0
            pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
            
            if (prevPageButton && prevPageButton.parentElement) {
                prevPageButton.parentElement.classList.toggle('disabled', currentPage === 1);
            }
            if (nextPageButton && nextPageButton.parentElement) {
                nextPageButton.parentElement.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
            }
        }

        // Update entries count
        updateEntriesCount();

        // Handle empty table state dynamically
        handleEmptyTable();
    }

     function handleEmptyTable() {
        const emptyRow = tbody.querySelector('.empty-row');
        const hasDataRows = currentRows.length > 0;
        const colspanValue = 3; // Number of columns in the header

        if (!hasDataRows && !emptyRow) {
            // Add empty message if no data rows and message doesn't exist
            const tr = document.createElement('tr');
            tr.classList.add('empty-row');
            tr.innerHTML = `<td colspan="${colspanValue}" class="text-center text-muted py-3">No matching records found.</td>`;
            tbody.appendChild(tr);
        } else if (hasDataRows && emptyRow) {
            // Remove empty message if data rows exist and message exists
            emptyRow.remove();
        }

        // Update footer info for empty state
        if (!hasDataRows) {
             pageInfoSpan.textContent = `Page 0 of 0`;
             tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
             prevPageButton.parentElement.classList.add('disabled');
             nextPageButton.parentElement.classList.add('disabled');
        } else if (originalRows.length === 0 && !emptyRow) {
             // Handle case where table was initially empty (keep Django's message)
             const initialEmptyRow = tbody.querySelector(`td[colspan='${colspanValue}']`);
             if (initialEmptyRow) {
                 pageInfoSpan.textContent = `Page 0 of 0`;
                 tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                 prevPageButton.parentElement.classList.add('disabled');
                 nextPageButton.parentElement.classList.add('disabled');
             }
        }
    }


    function updateRecordsPerPage() {
        recordsPerPage = parseInt(this.value);
        totalPages = Math.ceil(currentRows.length / recordsPerPage);
        if (totalPages === 0) totalPages = 1;
        currentPage = 1; // Reset to first page
        displayPage(currentPage);
    }

    function updateEntriesCount() {
        if (!tableInfoDiv) return;
        const totalEntries = currentRows.length;
        const urlParams = new URLSearchParams(window.location.search);
        const showAll = urlParams.get('all') === '1';
        
        if (totalEntries === 0) {
            tableInfoDiv.textContent = 'No entries found';
        } else if (showAll) {
            tableInfoDiv.textContent = `Showing all ${totalEntries} entries`;
        } else {
            const start = (currentPage - 1) * recordsPerPage + 1;
            const end = Math.min(currentPage * recordsPerPage, totalEntries);
            tableInfoDiv.textContent = `Showing ${start} to ${end} of ${totalEntries} entries`;
        }
    }

    function filterTable() {
        const filter = searchFilterInput.value.toLowerCase();
        currentRows = originalRows.filter(row => {
            const cells = row.getElementsByTagName("td");
            // Check ID (index 0) and SPV (index 1)
            return (cells[0] && cells[0].textContent.toLowerCase().includes(filter)) ||
                   (cells[1] && cells[1].textContent.toLowerCase().includes(filter));
        });
        totalPages = Math.ceil(currentRows.length / recordsPerPage);
        if (totalPages === 0) totalPages = 1;
        currentPage = 1; // Reset to first page after filtering
        
        // Update entries count
        updateEntriesCount();
        
        // Re-apply the last sort before displaying
        applySort();
    }

    // Make sortTable globally accessible for onclick handlers
    window.sortTable = function(n) {
        const currentDir = sortDirection[n] || 'asc'; // Default to asc if not sorted before or different column
        const newDir = (sortDirection[n] && currentDir === 'asc') ? 'desc' : 'asc';
        sortDirection = { [n]: newDir }; // Store new direction for this column only

        applySort(); // Apply the sort based on currentRows and sortDirection
        currentPage = 1; // Reset to first page after sorting
        // displayPage(currentPage); // applySort calls displayPage
        setArrow(n, newDir);
    }

    function applySort() {
        const columnIndex = Object.keys(sortDirection)[0]; // Get the index of the column to sort by
        if (columnIndex === undefined) return; // No sort applied yet

        const dir = sortDirection[columnIndex];
        const n = parseInt(columnIndex);

        currentRows.sort((a, b) => {
            const xCell = a.getElementsByTagName("TD")[n];
            const yCell = b.getElementsByTagName("TD")[n];
            const x = xCell ? xCell.textContent.toLowerCase() : '';
            const y = yCell ? yCell.textContent.toLowerCase() : '';

            let comparison = 0;

            // Try numeric sort for ID column (index 0)
            if (n === 0) {
                const numX = parseInt(x, 10); // Use parseInt for IDs
                const numY = parseInt(y, 10);
                if (!isNaN(numX) && !isNaN(numY)) {
                    comparison = numX - numY;
                } else {
                    comparison = x.localeCompare(y); // Fallback to string compare if not numeric
                }
            } else {
                 // Basic localeCompare for other columns (SPV)
                comparison = x.localeCompare(y);
            }


            return dir === "asc" ? comparison : -comparison; // Reverse comparison for desc
        });

        // Re-append sorted rows to tbody to ensure DOM order matches the sorted array
        const emptyRow = tbody.querySelector('.empty-row'); // Preserve empty row if present
        tbody.innerHTML = ''; // Clear tbody content
        if (emptyRow) tbody.appendChild(emptyRow); // Re-add empty row if it existed

        currentRows.forEach(row => tbody.appendChild(row));
        
        // Update entries count after sorting
        updateEntriesCount();
        
        // After re-appending, call displayPage to apply pagination slicing and visibility
        displayPage(currentPage);
    }


    function resetArrows() {
        document.getElementById("idSortArrow").innerHTML = "";
        document.getElementById("spvSortArrow").innerHTML = "";
    }

    function setArrow(n, dir) {
        resetArrows(); // Clear previous arrows
        const arrow = dir === "asc" ? '<i class="fas fa-sort-up ms-1"></i>' : '<i class="fas fa-sort-down ms-1"></i>';
        if (n === 0) {
            document.getElementById("idSortArrow").innerHTML = arrow;
        } else if (n === 1) {
            document.getElementById("spvSortArrow").innerHTML = arrow;
        }
    }

    // --- Event Listeners ---
    if (recordsPerPageSelect) {
        recordsPerPageSelect.addEventListener("change", updateRecordsPerPage);
    }
    if (searchFilterInput) {
        searchFilterInput.addEventListener("input", filterTable); // Use 'input' for responsive filtering
    }

    if (prevPageButton) {
        prevPageButton.addEventListener("click", function() {
            if (currentPage > 1) {
                // No need to call applySort here, just display previous page of currentRows
                displayPage(currentPage - 1);
            }
        });
    }

    if (nextPageButton) {
        nextPageButton.addEventListener("click", function() {
            if (currentPage < totalPages) {
                // No need to call applySort here, just display next page of currentRows
                displayPage(currentPage + 1);
            }
        });
    }

    // --- Initial Setup ---
    // Apply initial sort (ID descending)
    applySort();
    setArrow(0, 'desc'); // Set initial arrow after sorting

    // Initial display is handled by applySort calling displayPage
    // totalPages = Math.ceil(currentRows.length / recordsPerPage); // Recalculate initial totalPages
    // if (totalPages === 0) totalPages = 1;
    // displayPage(currentPage); // Initial display

});
</script>
{% endblock %}