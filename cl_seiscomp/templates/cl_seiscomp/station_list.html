{% extends 'core/base.html' %}
{% block title %}Station List{% endblock %}

{% block content %}
<style>
    .center-td td {
        text-align: center;
    }
</style>
<div class="container mt-4">
    <div class="form-container">
        <h1 class="page-header">Station List</h1>
        <div class="row justify-content-center">
            <div class="col-xl-12">
                <div class="d-flex justify-content-end align-items-center mb-4">
                    <div>
                        <a href="{% url 'cl_seiscomp:sl_create' %}" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-1"></i> Add Station
                        </a>
                        <a href="{% url 'cl_seiscomp:sl_bulk_create' %}" class="btn btn-primary">
                            <i class="fas fa-file-csv me-1"></i> Add Stations (CSV)
                        </a>
                    </div>
                </div>

                {% if has_map_data %}
                <!-- Map Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light py-2">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Station Locations</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="station-map"></div>
                    </div>
                </div>
                {% endif %}

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                        <div>
                            <label for="recordsPerPageTop" class="form-label me-2 mb-0 small">Show:</label>
                            <select id="recordsPerPageTop" class="form-select form-select-sm d-inline-block w-auto">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                            <span class="ms-1 small">entries</span>
                        </div>
                        <div class="input-group input-group-sm w-auto">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchFilter"
                                placeholder="Search Network, Code, Province, Location, UPT, Lon, Lat, ..." class="form-control">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 table-layout-fixed center-td" id="stationListTable">
                                <thead class="table-light">
                                    <tr>
                                        <th onclick="sortTable(0)" class="table-pointer table-col-10">Network <span id="networkSortArrow"></span></th>
<th onclick="sortTable(1)" class="table-pointer table-col-15">Code <span id="codeSortArrow"></span></th>
<th onclick="sortTable(2)" class="table-pointer table-col-20">Province <span id="provinceSortArrow"></span></th>
<th onclick="sortTable(3)" class="table-pointer table-col-20">Location <span id="locationSortArrow"></span></th>
<th onclick="sortTable(4)" class="table-pointer table-col-10">UPT <span id="uptSortArrow"></span></th>
<th class="table-col-15">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stationListTableBody">
                                    {% for record in station_list %}
                                    <tr>
                                        <td>{{ record.network }}</td>
                                        <td>{{ record.code }}</td>
                                        <td>{{ record.province }}</td>
                                        <td>{{ record.location }}</td>
                                        <td>{{ record.UPT }}</td>
                                        <td>
                                            <a href="{% url 'cl_seiscomp:sl_update' record.pk %}"
                                                class="btn btn-sm btn-warning me-1" data-bs-toggle="tooltip"
                                                title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{% url 'cl_seiscomp:sl_delete' record.pk %}" method="post"
                                                class="delete-form d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger delete-button"
                                                    data-bs-toggle="tooltip" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">No stations found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light d-flex justify-content-between align-items-center py-2">
                        <div id="tableInfo" class="small text-muted"></div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item"><button id="prevPage" class="page-link"><i
                                            class="fas fa-angle-left"></i></button></li>
                                <li class="page-item disabled"><span id="pageInfo" class="page-link"></span></li>
                                <li class="page-item"><button id="nextPage" class="page-link"><i
                                            class="fas fa-angle-right"></i></button></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            if (typeof bootstrap !== 'undefined') {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });

        // Initialize delete form confirmations
        const deleteForms = document.querySelectorAll('.delete-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                const confirmed = confirm('Are you sure you want to delete this item?');
                if (!confirmed) {
                    event.preventDefault();
                }
            });
        });

        let currentPage = 1;
let recordsPerPage = parseInt(document.getElementById("recordsPerPageTop").value);
const table = document.getElementById("stationListTable");
const tbody = document.getElementById("stationListTableBody");
const originalRows = Array.from(tbody.querySelectorAll("tr:not(:has(td[colspan='6']))"));
let currentRows = [...originalRows];
let totalPages = Math.ceil(currentRows.length / recordsPerPage);

// Sorting state
let sortDirection = {}; // e.g. {0: 'asc'}

window.sortTable = function (n) {
    const currentDir = sortDirection[n] || 'asc';
    const newDir = (sortDirection[n] && currentDir === 'asc') ? 'desc' : 'asc';
    sortDirection = { [n]: newDir };
    applySort();
    currentPage = 1;
    setArrow(n, newDir);
}

function applySort() {
    const columnIndex = Object.keys(sortDirection)[0];
    if (columnIndex === undefined) return;
    const dir = sortDirection[columnIndex];
    const n = parseInt(columnIndex);
    currentRows.sort((a, b) => {
        const xCell = a.getElementsByTagName("TD")[n];
        const yCell = b.getElementsByTagName("TD")[n];
        const x = xCell ? xCell.textContent.toLowerCase() : '';
        const y = yCell ? yCell.textContent.toLowerCase() : '';
        let comparison = 0;
        // Try numeric compare first
        const numX = parseFloat(x);
        const numY = parseFloat(y);
        if (!isNaN(numX) && !isNaN(numY)) {
            comparison = numX - numY;
        } else {
            comparison = x.localeCompare(y);
        }
        return dir === "asc" ? comparison : -comparison;
    });
    const emptyRow = tbody.querySelector('.empty-row');
    tbody.innerHTML = '';
    if (emptyRow) tbody.appendChild(emptyRow);
    currentRows.forEach(row => tbody.appendChild(row));
    displayPage(currentPage);
}

function resetArrows() {
    document.getElementById("networkSortArrow").innerHTML = "";
    document.getElementById("codeSortArrow").innerHTML = "";
    document.getElementById("provinceSortArrow").innerHTML = "";
    document.getElementById("locationSortArrow").innerHTML = "";
    document.getElementById("uptSortArrow").innerHTML = "";
    document.getElementById("longitudeSortArrow").innerHTML = "";
    document.getElementById("latitudeSortArrow").innerHTML = "";
}

function setArrow(n, dir) {
    resetArrows();
    const arrow = dir === "asc" ? '<i class="fas fa-sort-up ms-1"></i>' : '<i class="fas fa-sort-down ms-1"></i>';
    if (n === 0) {
        document.getElementById("networkSortArrow").innerHTML = arrow;
    } else if (n === 1) {
        document.getElementById("codeSortArrow").innerHTML = arrow;
    } else if (n === 2) {
        document.getElementById("provinceSortArrow").innerHTML = arrow;
    } else if (n === 3) {
        document.getElementById("locationSortArrow").innerHTML = arrow;
    } else if (n === 4) {
        document.getElementById("uptSortArrow").innerHTML = arrow;
    } else if (n === 5) {
        document.getElementById("longitudeSortArrow").innerHTML = arrow;
    } else if (n === 6) {
        document.getElementById("latitudeSortArrow").innerHTML = arrow;
    }
}


        const pageInfoSpan = document.getElementById("pageInfo");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const recordsPerPageSelect = document.getElementById("recordsPerPageTop");
        const searchFilterInput = document.getElementById("searchFilter");
        const tableInfoDiv = document.getElementById("tableInfo");

        function displayPage(page) {
            currentPage = page;
            const start = (page - 1) * recordsPerPage;
            const end = start + recordsPerPage;

            originalRows.forEach(row => row.style.display = 'none');
            const pageRows = currentRows.slice(start, end);
            pageRows.forEach(row => row.style.display = '');

            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;

            // Disable/enable pagination buttons
            prevPageButton.parentElement.classList.toggle('disabled', currentPage === 1);
            nextPageButton.parentElement.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);

            const startRecord = currentRows.length > 0 ? start + 1 : 0;
            const endRecord = Math.min(end, currentRows.length);
            tableInfoDiv.textContent = `Showing ${startRecord} to ${endRecord} of ${currentRows.length} entries`;

            handleEmptyTable();
        }

        function handleEmptyTable() {
            const emptyRow = tbody.querySelector('.empty-row');
            const hasDataRows = currentRows.length > 0;
            const colspanValue = 6;

            if (!hasDataRows && !emptyRow) {
                const tr = document.createElement('tr');
                tr.classList.add('empty-row');
                tr.innerHTML = `<td colspan="${colspanValue}" class="text-center text-muted py-3">No matching records found.</td>`;
                tbody.appendChild(tr);
            } else if (hasDataRows && emptyRow) {
                emptyRow.remove();
            }

            if (!hasDataRows) {
                pageInfoSpan.textContent = `Page 0 of 0`;
                tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                prevPageButton.parentElement.classList.add('disabled');
                nextPageButton.parentElement.classList.add('disabled');
            } else if (originalRows.length === 0 && !emptyRow) {
                const initialEmptyRow = tbody.querySelector(`td[colspan='${colspanValue}']`);
                if (initialEmptyRow) {
                    pageInfoSpan.textContent = `Page 0 of 0`;
                    tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                    prevPageButton.parentElement.classList.add('disabled');
                    nextPageButton.parentElement.classList.add('disabled');
                }
            }
        }

        function filterTable() {
            const filter = searchFilterInput.value.toLowerCase();
            currentRows = originalRows.filter(row => {
                const cells = row.getElementsByTagName("td");
                return (cells[0] && cells[0].textContent.toLowerCase().includes(filter)) ||
                    (cells[1] && cells[1].textContent.toLowerCase().includes(filter)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filter)) ||
                    (cells[3] && cells[3].textContent.toLowerCase().includes(filter)) ||
                    (cells[4] && cells[4].textContent.toLowerCase().includes(filter));
            });
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            currentPage = 1;
            handleEmptyTable();
            displayPage(currentPage);
        }

        function updateRecordsPerPage() {
            recordsPerPage = parseInt(this.value);
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            currentPage = 1;
            displayPage(currentPage);
        }

        // Initialize sorting
        let sortColumn = null;
        let sortOrder = 1; // 1 for ascending, -1 for descending

        function sortTable(column) {
            if (sortColumn === column) {
                sortOrder *= -1; // Toggle sort order
            } else {
                sortColumn = column;
                sortOrder = 1; // Start with ascending
            }

            // Clear sort arrows
            const arrows = document.querySelectorAll(".sort-arrow");
            arrows.forEach(arrow => arrow.remove());

            // Add sort arrow to current column
            const arrow = document.createElement("span");
            arrow.className = "sort-arrow";
            arrow.innerHTML = sortOrder === 1 ? "&#x25B2;" : "&#x25BC;";
            const header = document.querySelector(`th:nth-child(${column + 1})`);
            header.appendChild(arrow);

            // Sort the rows
            currentRows.sort((a, b) => {
                const cellA = a.cells[column].textContent.trim();
                const cellB = b.cells[column].textContent.trim();
                
                // Handle numeric values
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return (numA - numB) * sortOrder;
                }
                
                // For strings
                return cellA.localeCompare(cellB) * sortOrder;
            });

            // Update display
            currentPage = 1;
            displayPage(1);
        }

        // Initialize event listeners
        recordsPerPageSelect.addEventListener("change", updateRecordsPerPage);
        searchFilterInput.addEventListener("input", filterTable);
        prevPageButton.addEventListener("click", function () {
            if (currentPage > 1) {
                currentPage--;
                displayPage(currentPage);
            }
        });
        nextPageButton.addEventListener("click", function () {
            if (currentPage < totalPages) {
                currentPage++;
                displayPage(currentPage);
            }
        });

        // Initialize display
        handleEmptyTable();
        displayPage(currentPage);
    });
</script>

{% if has_map_data %}
<!-- Plotly JS -->
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
<script>
    // Render the map
    const mapData = {{ map_data|safe }};
    Plotly.newPlot('station-map', mapData.data, mapData.layout, {responsive: true});
</script>
{% endif %}
{% endblock %}