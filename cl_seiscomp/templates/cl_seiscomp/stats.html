{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">Seiscomp Statistics</h1>
    
    <div class="d-flex flex-wrap gap-2 mb-4">
        <div class="form-floating flex-grow-1">
            <input type="date" class="form-control" id="start_date" name="start_date" 
                   value="{{ start_date|date:'Y-m-d' }}" required>
            <label for="start_date">Start Date</label>
        </div>
        <div class="form-floating flex-grow-1">
            <input type="date" class="form-control" id="end_date" name="end_date" 
                   value="{{ end_date|date:'Y-m-d' }}" required>
            <label for="end_date">End Date</label>
        </div>
        <div class="form-floating flex-grow-1">
            <select class="form-select" id="time" name="time">
                <option value="">All Times</option>
                {% for value, text in times %}
                <option value="{{ value }}" {% if value == selected_time %}selected{% endif %}>{{ text }}</option>
                {% endfor %}
            </select>
            <label for="time">Time</label>
        </div>
        <button type="submit" class="btn btn-primary">Update Chart</button>
    </div>

    <div class="card">
        <div class="card-body">
            <canvas id="statsChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('statsChart').getContext('2d');
    const dates = {{ dates|safe }};
    const gapsData = {{ gaps_data|safe }};
    const blanksData = {{ blanks_data|safe }};
    const spikesData = {{ spikes_data|safe }};
    const slmonData = {{ slmon_data|safe }};

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Gaps',
                    data: gapsData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    hidden: false
                },
                {
                    label: 'Blanks',
                    data: blanksData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    hidden: false
                },
                {
                    label: 'Spikes',
                    data: spikesData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    hidden: false
                },
                {
                    label: 'SLMON',
                    data: slmonData,
                    borderColor: 'rgb(255, 205, 86)',
                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                    hidden: false
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Seiscomp Statistics ({{ start_date|date:"M Y" }} - {{ end_date|date:"M Y" }})'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Add toggle functionality
    document.querySelector('canvas').addEventListener('click', function(event) {
        const elements = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
        if (elements.length > 0) {
            const datasetIndex = elements[0].datasetIndex;
            chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
            chart.update();
        }
    });

    // Update date inputs with current date range
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (startDateInput && endDateInput) {
        // Set min/max dates for inputs
        const today = new Date();
        const minDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
        
        startDateInput.min = minDate.toISOString().split('T')[0];
        endDateInput.min = startDateInput.value;
        endDateInput.max = today.toISOString().split('T')[0];
        
        // Update min/max when start date changes
        startDateInput.addEventListener('change', () => {
            endDateInput.min = startDateInput.value;
        });
    }
});
</script>
{% endblock %}
