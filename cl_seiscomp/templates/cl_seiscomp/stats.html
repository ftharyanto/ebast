{% extends 'base.html' %}
{% load static %}

<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 30px;
        text-align: center;
    }

    .form-floating label {
        font-size: 1.1em;
        color: #333;
    }

    .form-control, .form-select {
        font-size: 1.1em;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #ddd;
    }

    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        font-size: 1.1em;
        border-radius: 0.5rem;
        background-color: #007bff;
        border: none;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        margin-top: 30px;
    }

    .card-body {
        padding: 2rem;
    }

    #statsChart {
        min-height: 500px;
        margin: 0 auto;
    }
</style>

{% block content %}
<div class="form-container">
    <h1 class="page-header">Station Statistics</h1>
    
    <form method="get" action="">
        <div class="d-flex flex-wrap gap-2 mb-4">
            <div class="form-floating flex-grow-1">
                <input type="date" class="form-control" id="start_date" name="start_date" 
                       value="{{ start_date|date:'Y-m-d' }}" required>
                <label for="start_date">Start Date</label>
            </div>
            <div class="form-floating flex-grow-1">
                <input type="date" class="form-control" id="end_date" name="end_date" 
                       value="{{ end_date|date:'Y-m-d' }}" required>
                <label for="end_date">End Date</label>
            </div>
            <div class="form-floating flex-grow-1">
                <select class="form-select" id="time" name="time">
                    <option value="">All Times</option>
                    {% for value, text in times %}
                    <option value="{{ value }}" {% if value == selected_time %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
                <label for="time">Time</label>
            </div>
            <button type="submit" class="btn btn-primary">Update Chart</button>
        </div>
    </form>

    <div class="card">
        <div class="card-body">
            <div id="statsChart"></div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-body">
            <div id="stationChart"></div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load the main plot from JSON
    const plotData = {{ plot_json|safe }};
    const stationPlotData = {{ station_plot_json|safe }};
    
    // Create main chart with improved x-axis tick formatting
    Plotly.newPlot('statsChart', plotData.data, {
        ...plotData.layout,
        xaxis: {
            ...plotData.layout.xaxis,
            tickformatstops: [
                {dtickrange: [null, 1000 * 60 * 60 * 24], value: "%H:%M"}, // For less than 1 day
                {dtickrange: [1000 * 60 * 60 * 24, 1000 * 60 * 60 * 24 * 7], value: "%b %d"}, // For 1-7 days
                {dtickrange: [1000 * 60 * 60 * 24 * 7, 1000 * 60 * 60 * 24 * 30], value: "%b %d"}, // For 1-4 weeks
                {dtickrange: [1000 * 60 * 60 * 24 * 30, 1000 * 60 * 60 * 24 * 90], value: "%b"}, // For 1-3 months
                {dtickrange: [1000 * 60 * 60 * 24 * 90, null], value: "%Y-%m"} // For more than 3 months
            ],
            tickmode: 'auto',
            nticks: 10
        }
    });
    
    // Create station error frequency chart
    Plotly.newPlot('stationChart', stationPlotData.data, stationPlotData.layout);

    // Update date inputs with current date range
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const timeSelect = document.getElementById('time');
    
    if (startDateInput && endDateInput) {
        // Set min/max dates for inputs
        const today = new Date();
        const minDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
        
        startDateInput.min = minDate.toISOString().split('T')[0];
        endDateInput.min = startDateInput.value;
        endDateInput.max = today.toISOString().split('T')[0];
        
        // Update min/max when start date changes
        startDateInput.addEventListener('change', () => {
            endDateInput.min = startDateInput.value;
        });

        // Update the chart when any input changes
        function updateChart() {
            const formData = new FormData();
            formData.append('start_date', startDateInput.value);
            formData.append('end_date', endDateInput.value);
            formData.append('time', timeSelect.value);

            // Submit the form
            document.querySelector('form').submit();
        }

        // Add change listeners to all inputs
        startDateInput.addEventListener('change', updateChart);
        endDateInput.addEventListener('change', updateChart);
        timeSelect.addEventListener('change', updateChart);
    }
});
</script>
{% endblock %}
