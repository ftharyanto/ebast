{% extends 'core/base.html' %}
{% load static %}
{% block title %}Ceklis Seiscomp{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">Ceklis Seiscomp</h1>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-xl-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        {% if request.GET.all == '1' %}
                        <form method="get" class="d-inline-block">
                            {% for key, value in request.GET.items %}
                                {% if key != 'all' %}<input type="hidden" name="{{ key }}" value="{{ value }}" />{% endif %}
                            {% endfor %}
                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-table me-1"></i> Show 10 Last Records
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% url 'cl_seiscomp:cs_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> Add New Record
                        </a>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                        {% if not request.GET.all %}
                        <div class="d-flex align-items-center">
                            <label for="recordsPerPageTop" class="form-label me-2 mb-0 small">Show:</label>
                            <select id="recordsPerPageTop" class="form-select form-select-sm d-inline-block w-auto">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                            </select>
                            <span class="ms-1 small">entries</span>
                        </div>
                        {% else %}
                        <div id="tableInfo" class="small text-muted"></div>
                        {% endif %}
                        <div class="input-group input-group-sm w-auto">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchFilter" placeholder="Search ID, Jam, Kelompok, Operator..."
                                class="form-control">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 table-layout-fixed" id="csRecordTable">
                                <thead class="table-light">
                                    <tr>
                                        <th onclick="sortTable(0)" class="table-pointer table-col-15">ID <span
                                                id="idSortArrow"></span></th>
                                        <th onclick="sortTable(1)" class="table-pointer table-col-10">Jam Pelaksanaan
                                            <span id="jampelSortArrow"></span>
                                        </th>
                                        <th onclick="sortTable(2)" class="table-pointer table-col-10">Kelompok <span
                                                id="kelompokSortArrow"></span></th>
                                        <th onclick="sortTable(3)" class="table-pointer table-col-10">Blank <span
                                                id="blankSortArrow"></span></th>
                                        <th onclick="sortTable(4)" class="table-pointer table-col-25">Operator <span
                                                id="operatorSortArrow"></span></th>
                                        <th class="table-col-15">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="csRecordTableBody">
                                    {% for record in csrecords %}
                                    <tr>
                                        <td>{{ record.cs_id }}</td>
                                        <td style="text-align: center;">{{ record.jam_pelaksanaan }}</td>
                                        <td style="text-align: center;">{{ record.kelompok }}</td>
                                        <td style="text-align: center;">{{ record.count_blanks }}</td>
                                        <td class="ellipsis-cell">{{ record.operator }}</td>
                                        <td>
                                            <a href="{% url 'cl_seiscomp:cs_update' record.pk %}"
                                                class="btn btn-sm btn-warning me-1" data-bs-toggle="tooltip"
                                                title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{% url 'cl_seiscomp:cs_delete' record.pk %}" method="post"
                                                class="delete-form d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger delete-button me-1"
                                                    data-bs-toggle="tooltip" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            <a href="{% url 'cl_seiscomp:cs_export_excel' record.pk %}"
                                                class="btn btn-sm btn-light text-success me-1" data-bs-toggle="tooltip"
                                                title="Export to Excel">
                                                <i class="fas fa-file-excel"></i>
                                            </a>
                                            <a href="{% url 'cl_seiscomp:cs_export_pdf' record.pk %}"
                                                class="btn btn-sm btn-light text-danger" data-bs-toggle="tooltip"
                                                title="Export to PDF">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">No Ceklis Seiscomp records
                                            found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                        <div class="card-footer bg-light py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- Entries Info -->
                            <div id="tableInfo" class="small text-muted"></div>
                            
                            <!-- Pagination and Actions -->
                            <div class="d-flex align-items-center">
                                {% if not request.GET.all %}
                                    <!-- Pagination -->
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination mb-0 me-2">
                                            <li class="page-item">
                                                <button id="prevPage" class="page-link"><i class="fas fa-angle-left"></i></button>
                                            </li>
                                            <li class="page-item">
                                                <span id="pageInfo" class="page-link"></span>
                                            </li>
                                            <li class="page-item">
                                                <button id="nextPage" class="page-link"><i class="fas fa-angle-right"></i></button>
                                            </li>
                                        </ul>
                                    </nav>

                                    <!-- Show All Button -->
                                    <form method="get" class="d-inline-block">
                                        {% for key, value in request.GET.items %}
                                            {% if key != 'all' %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}" />
                                            {% endif %}
                                        {% endfor %}
                                        <input type="hidden" name="all" value="1" />
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-list"></i> Show All Records
                                        </button>
                                    </form>
                                {% else %}
                                    <!-- Show Paged View Button -->
                                    <form method="get" class="d-inline-block">
                                        {% for key, value in request.GET.items %}
                                            {% if key != 'all' %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}" />
                                            {% endif %}
                                        {% endfor %}
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-table"></i> Show 10 Last Records
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize tooltips (assuming Bootstrap 5)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            if (typeof bootstrap !== 'undefined') {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });

        // Initialize delete confirmations
        const deleteForms = document.querySelectorAll('.delete-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                const confirmed = confirm('Are you sure you want to delete this item?');
                if (!confirmed) {
                    event.preventDefault();
                }
            });
        });

        const table = document.getElementById("csRecordTable");
        const tbody = document.getElementById("csRecordTableBody");
        // Store original data rows, exclude empty message row if present
        const originalRows = Array.from(tbody.querySelectorAll("tr:not(:has(td[colspan='6']))"));
        let currentRows = [...originalRows]; // Rows currently being displayed/filtered/sorted
        let currentPage = 1;
        let recordsPerPage = 10;
        let totalPages = 1;
        
        // Only set recordsPerPage if the select exists (when not in 'all' view)
        if (document.getElementById("recordsPerPageTop")) {
            recordsPerPage = parseInt(document.getElementById("recordsPerPageTop").value) || 10;
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
        }

        // Initial sort: ID descending (column 0)
        let sortDirection = { 0: 'desc' };

        const pageInfoSpan = document.getElementById("pageInfo");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const recordsPerPageSelect = document.getElementById("recordsPerPageTop");
        const searchFilterInput = document.getElementById("searchFilter");
        const tableInfoDiv = document.getElementById("tableInfo");

        function updateEntriesCount() {
            if (!tableInfoDiv) return;
            const totalEntries = currentRows.length;
            const urlParams = new URLSearchParams(window.location.search);
            const showAll = urlParams.get('all') === '1';
            
            if (totalEntries === 0) {
                tableInfoDiv.textContent = 'No entries found';
            } else if (showAll) {
                tableInfoDiv.textContent = `Showing all ${totalEntries} entries`;
            } else {
                const start = (currentPage - 1) * recordsPerPage + 1;
                const end = Math.min(currentPage * recordsPerPage, totalEntries);
                tableInfoDiv.textContent = `Showing ${start} to ${end} of ${totalEntries} entries`;
            }
        }

        function displayPage(page) {
            // If we're in 'all' view, show all records
            const urlParams = new URLSearchParams(window.location.search);
            const showAll = urlParams.get('all') === '1';
            
            if (showAll) {
                // Show all records
                originalRows.forEach(row => row.style.display = '');
                totalPages = 1;
                currentPage = 1;
            } else {
                // Paginated view
                const start = (page - 1) * recordsPerPage;
                const end = start + recordsPerPage;

                originalRows.forEach(row => row.style.display = 'none');

                const pageRows = currentRows.slice(start, end);
                pageRows.forEach(row => row.style.display = '');

                totalPages = Math.ceil(currentRows.length / recordsPerPage);
                if (totalPages === 0) totalPages = 1;
            }

            // Only update page info if pageInfoSpan exists
            if (pageInfoSpan) {
                if (showAll) {
                    pageInfoSpan.textContent = 'Showing all records';
                } else {
                    pageInfoSpan.textContent = `Page ${page} of ${totalPages}`;
                }
            }

            // Only update pagination buttons if they exist
            if (prevPageButton && nextPageButton) {
                if (showAll) {
                    prevPageButton.parentElement.classList.add('disabled');
                    nextPageButton.parentElement.classList.add('disabled');
                } else {
                    prevPageButton.parentElement.classList.toggle('disabled', page === 1);
                    nextPageButton.parentElement.classList.toggle('disabled', page === totalPages || totalPages === 0);
                }
            }

            updateEntriesCount();

            handleEmptyTable();
        }

        function handleEmptyTable() {
            const emptyRow = tbody.querySelector('.empty-row');
            const hasDataRows = currentRows.length > 0;
            const colspanValue = 6;

            if (!hasDataRows && !emptyRow) {
                const tr = document.createElement('tr');
                tr.classList.add('empty-row');
                tr.innerHTML = `<td colspan="${colspanValue}" class="text-center text-muted py-3">No Ceklis Seiscomp records found.</td>`;
                tbody.appendChild(tr);
            } else if (hasDataRows && emptyRow) {
                emptyRow.remove();
            }

            if (!hasDataRows) {
                pageInfoSpan.textContent = `Page 0 of 0`;
                tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                prevPageButton.parentElement.classList.add('disabled');
                nextPageButton.parentElement.classList.add('disabled');
            } else if (originalRows.length === 0 && !emptyRow) {
                const initialEmptyRow = tbody.querySelector(`td[colspan='${colspanValue}']`);
                if (initialEmptyRow) {
                    pageInfoSpan.textContent = `Page 0 of 0`;
                    tableInfoDiv.textContent = `Showing 0 to 0 of 0 entries`;
                    prevPageButton.parentElement.classList.add('disabled');
                    nextPageButton.parentElement.classList.add('disabled');
                }
            }
        }

        function updateRecordsPerPage() {
            recordsPerPage = parseInt(this.value);
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            currentPage = 1;
            displayPage(currentPage);
        }

        function filterTable() {
            const filter = searchFilterInput.value.toLowerCase();
            currentRows = originalRows.filter(row => {
                const cells = row.getElementsByTagName("td");
                return (cells[0] && cells[0].textContent.toLowerCase().includes(filter)) ||
                    (cells[1] && cells[1].textContent.toLowerCase().includes(filter)) ||
                    (cells[2] && cells[2].textContent.toLowerCase().includes(filter)) ||
                    (cells[4] && cells[4].textContent.toLowerCase().includes(filter));
            });
            totalPages = Math.ceil(currentRows.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;
            currentPage = 1;

            updateEntriesCount();

            applySort();
        }

        window.sortTable = function (n) {
            const currentDir = sortDirection[n] || 'asc';
            const newDir = (sortDirection[n] && currentDir === 'asc') ? 'desc' : 'asc';
            sortDirection = { [n]: newDir };

            applySort();
            currentPage = 1;
            setArrow(n, newDir);
        }

        function applySort() {
            const columnIndex = Object.keys(sortDirection)[0];
            if (columnIndex === undefined) return;

            const dir = sortDirection[columnIndex];
            const n = parseInt(columnIndex);

            currentRows.sort((a, b) => {
                const xCell = a.getElementsByTagName("TD")[n];
                const yCell = b.getElementsByTagName("TD")[n];
                const x = xCell ? xCell.textContent.toLowerCase() : '';
                const y = yCell ? yCell.textContent.toLowerCase() : '';

                let comparison = 0;

                if (n === 0) {
                    const numX = parseInt(x, 10);
                    const numY = parseInt(y, 10);
                    if (!isNaN(numX) && !isNaN(numY)) {
                        comparison = numX - numY;
                    } else {
                        comparison = x.localeCompare(y);
                    }
                } else {
                    comparison = x.localeCompare(y);
                }

                return dir === "asc" ? comparison : -comparison;
            });

            const emptyRow = tbody.querySelector('.empty-row');
            tbody.innerHTML = '';
            if (emptyRow) tbody.appendChild(emptyRow);

            currentRows.forEach(row => tbody.appendChild(row));

            updateEntriesCount();

            displayPage(currentPage);
        }

        function resetArrows() {
            const arrows = document.querySelectorAll('.table-pointer span');
            arrows.forEach(arrow => arrow.textContent = '');
        }

        function setArrow(n, dir) {
            const arrow = document.getElementById(`${n}SortArrow`);
            if (arrow) {
                arrow.textContent = dir === 'asc' ? '↑' : '↓';
            }
        }

        // Only add event listeners if the elements exist
        if (recordsPerPageSelect) {
            recordsPerPageSelect.addEventListener("change", updateRecordsPerPage);
        }
        if (searchFilterInput) {
            searchFilterInput.addEventListener("input", filterTable);
        }

        if (prevPageButton) {
            prevPageButton.addEventListener("click", function () {
                if (currentPage > 1) {
                    displayPage(currentPage - 1);
                }
            });
        }

        if (nextPageButton) {
            nextPageButton.addEventListener("click", function () {
                if (currentPage < totalPages) {
                    displayPage(currentPage + 1);
                }
            });
        }

        applySort();
        setArrow(0, 'desc');
    });
</script>
{% endblock %}