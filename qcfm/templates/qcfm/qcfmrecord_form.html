{% extends 'core/base.html' %}
{% block content %}
<div class="form-container">
    <div class="container">
        <h1 class="page-header">QC FM Record Form</h1>
        <p>Sumber data: <a href="http://202.90.198.41/qc_focal.txt"
                target="_blank">http://202.90.198.41/qc_focal.txt</a></p>
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            {% load form_tags %}

            {% if form.errors %}
            <div id="form-errors" data-errors="true" style="display: none;">
                {% for field in form %}
                {% if field.errors %}
                {% for error in field.errors %}
                <div data-field="{{ field.id_for_label }}" data-error="{{ error|escapejs }}"></div>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="form-group row">
                <div class="col-md-4">
                    {{ form.date.label_tag }}
                    <div class="input-group">
                        {{ form.date|add_class:"form-control date-picker" }}
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                    <div class="invalid-feedback">
                        Please provide a valid date.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.shift.label_tag }}
                    {{ form.shift|add_class:"form-select" }}
                </div>
                <div class="col-md-4">
                    {{ form.qcfm_id.label_tag }}
                    <input type="text" name="{{ form.qcfm_id.name }}" value="{{ form.qcfm_id.value|default:'' }}"
                        class="form-control bg-light" id="{{ form.qcfm_id.id_for_label }}" readonly
                        style="cursor: not-allowed;">
                    <div class="invalid-feedback">
                        Please provide a valid QC FM ID.
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="form-group col-md-4">
                        {{ form.kelompok.label_tag }}
                        {{ form.kelompok|add_class:"form-select" }}
                        <div class="invalid-feedback">
                            Please select a valid kelompok.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.jam_pelaksanaan.label_tag }}
                        {{ form.jam_pelaksanaan|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            Please fill a valid jam pelaksanaan.
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.kel_sebelum.id_for_label }}">Kelompok Sebelumnya</label>
                        {{ form.kel_sebelum|add_class:"form-select" }}
                        <div class="invalid-feedback">
                            Please fill a valid kelompok sebelumnya.
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qcfm_prev_start">Start Date and Time (UTC)</label>
                        <div class="input-group">
                            <input type="datetime" id="datetime_qcfm_prev_start" class="form-control datetime-picker"
                                value="2024-12-14 00:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qcfm_prev_end">End Date and Time (UTC)</label>
                        <div class="input-group">
                            <input type="datetime" id="datetime_qcfm_prev_end" class="form-control datetime-picker"
                                value="2024-12-14 07:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qcfm_prev" class="btn btn-primary align-bottom">Fetch
                            Data</button>
                    </div>
                </div>
                <!-- Accordion for fetched data and qcfm_prev form -->
                <div class="accordion mb-3" id="fetchedDataAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button bg-light" type="button" data-bs-toggle="collapse"
                                data-bs-target="#fetchedDataSection" aria-expanded="true"
                                aria-controls="fetchedDataSection">
                                <b>Fetched Data</b>
                            </button>
                        </h2>
                        <div id="fetchedDataSection" class="accordion-collapse collapse" aria-labelledby="headingOne"
                            data-bs-parent="#fetchedDataAccordion">
                            <div class="card-body p-4">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover table-sm"
                                        id="fetched-data-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>No</th>
                                                <th>Date</th>
                                                <th>OT (UTC)</th>
                                                <th>Lat</th>
                                                <th>Long</th>
                                                <th>Mag</th>
                                                <th>TypeMag</th>
                                                <th>D(Km)</th>
                                                <th>S1</th>
                                                <th>D1</th>
                                                <th>R1</th>
                                                <th>S2</th>
                                                <th>D2</th>
                                                <th>R2</th>
                                                <th>Fit (%)</th>
                                                <th>CLVD (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                {{ form.qcfm_prev.label_tag }}
                                {{ form.qcfm_prev|add_class:"form-control" }}
                                <div class="invalid-feedback">
                                    Please provide a valid previous QC FM.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group row">
                    <div class="col-md-4">
                        <label for="datetime_qcfm_start">Start Date and Time (UTC)</label>
                        <div class="input-group">
                            <input type="datetime" id="datetime_qcfm_start" class="form-control datetime-picker"
                                value="2024-12-14 00:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="datetime_qcfm_end">End Date and Time (UTC)</label>
                        <div class="input-group">
                            <input type="datetime" id="datetime_qcfm_end" class="form-control datetime-picker"
                                value="2024-12-14 07:00:00">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="fetch_qcfm" class="btn btn-primary align-bottom">Fetch Data</button>
                    </div>
                </div>
                <!-- Accordion for fetched data and qc form -->
                <div class="accordion mb-3" id="qcFmDataAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button bg-light" type="button" data-bs-toggle="collapse"
                                data-bs-target="#qcFmDataSection" aria-expanded="true" aria-controls="qcFmDataSection">
                                <b>Fetched QC Data</b>
                            </button>
                        </h2>
                        <div id="qcFmDataSection" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                            data-bs-parent="#qcFmDataAccordion">
                            <div class="card-body p-4">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover table-sm"
                                        id="qc-fm-data-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>No</th>
                                                <th>Date</th>
                                                <th>OT (UTC)</th>
                                                <th>Lat</th>
                                                <th>Long</th>
                                                <th>Mag</th>
                                                <th>TypeMag</th>
                                                <th>D(Km)</th>
                                                <th>S1</th>
                                                <th>D1</th>
                                                <th>R1</th>
                                                <th>S2</th>
                                                <th>D2</th>
                                                <th>R2</th>
                                                <th>Fit (%)</th>
                                                <th>CLVD (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                {{ form.qcfm.label_tag }}
                                {{ form.qcfm|add_class:"form-control" }}
                                <div class="invalid-feedback">
                                    Please provide a valid QC.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-6">
                    {{ form.operator.label_tag }}
                    {{ form.operator|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please select a valid operator.
                    </div>
                </div>
                <div class="col-md-6">
                    {{ form.NIP.label_tag }}
                    {{ form.NIP|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid NIP.
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="invalid-feedback">
                    Please provide a valid date.
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <a href="{% url 'qcfm:qcfmrecord_list' %}" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

<!-- Helper function for showing error messages in modal -->
<script>
    function showErrorModal(message) {
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const errorContent = document.getElementById('errorModalContent');
        errorContent.innerHTML = `<p>${message}</p>`;
        errorModal.show();
    }
</script>
<script>
    // date picker initialization
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        dateInput.type = 'date';
    });

    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Helper for QCFM ID suffix
    function getQcfmSuffix(waktuDinasValue) {
        switch (waktuDinasValue) {
            case 'Dini Hari':
                return '1D';
            case 'Pagi':
                return '2P';
            case 'Siang':
                return '3S';
            case 'Malam':
                return '4M';
            default:
                return '';
        }
    }
    // change qcfm_id value based on date_input and waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const qcIdInput = document.getElementById('{{ form.qcfm_id.id_for_label }}');
        qcIdInput.value = "QCFM-" + dateInput.value + "-" + getQcfmSuffix(waktuDinasSelect.value);

        function updateQcId() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            qcIdInput.value = "QCFM-" + dateValue + "-" + getQcfmSuffix(waktuDinasValue);
        }

        dateInput.addEventListener('change', updateQcId);
        waktuDinasSelect.addEventListener('change', updateQcId);
    });

    // Fetch data and fill qcfm_prev
    document.getElementById('fetch_qcfm_prev').addEventListener('click', function () {
        const startDatetime = document.getElementById('datetime_qcfm_prev_start').value.replace('T', ' ');
        const endDatetime = document.getElementById('datetime_qcfm_prev_end').value.replace('T', ' ');
        const url = `{% url 'qcfm:fetch_data' 'start_datetime' 'end_datetime' %}`
            .replace('start_datetime', encodeURIComponent(startDatetime))
            .replace('end_datetime', encodeURIComponent(endDatetime));

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const qcPrevInput = document.querySelector('[name="{{ form.qcfm_prev.name }}"]');
                qcPrevInput.value = data.csv;

                // Populate the table with fetched data
                const tableBody = document.getElementById('fetched-data-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Simulate a click on the accordion button if not already expanded
                const fetchedDataSection = document.getElementById('fetchedDataSection');
                if (!fetchedDataSection.classList.contains('show')) {
                    document.querySelector('[data-bs-target="#fetchedDataSection"]').click();
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                showErrorModal('Error fetching data: ' + error.message);
            });
    });

    // Fetch data and fill qc
    document.getElementById('fetch_qcfm').addEventListener('click', function () {
        const startDatetime = document.getElementById('datetime_qcfm_start').value.replace('T', ' ');
        const endDatetime = document.getElementById('datetime_qcfm_end').value.replace('T', ' ');
        const url = `{% url 'qcfm:fetch_data' 'start_datetime' 'end_datetime' %}`
            .replace('start_datetime', encodeURIComponent(startDatetime))
            .replace('end_datetime', encodeURIComponent(endDatetime));

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const qcInput = document.querySelector('[name="{{ form.qcfm.name }}"]');
                qcInput.value = data.csv;

                // Populate the table with fetched data
                const tableBody = document.getElementById('qc-fm-data-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.table_data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                // Simulate a click on the accordion button if not already expanded
                const qcFmDataSection = document.getElementById('qcFmDataSection');
                if (!qcFmDataSection.classList.contains('show')) {
                    document.querySelector('[data-bs-target="#qcFmDataSection"]').click();
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                showErrorModal('Error fetching data: ' + error.message);
            });
    });

    // set the datetime_qcfm_prev_start and datetime_qcfm_prev_end default value to be dependent on the waktu_dinas
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('{{ form.date.id_for_label }}');
        const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
        const datetimeQcPrevStart = document.getElementById('datetime_qcfm_prev_start');
        const datetimeQcPrevEnd = document.getElementById('datetime_qcfm_prev_end');
        const datetimeQcStart = document.getElementById('datetime_qcfm_start');
        const datetimeQcEnd = document.getElementById('datetime_qcfm_end');

        function updateDatetime() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            let startDatetime, endDatetime;

            const prevDay = new Date(dateValue);
            prevDay.setDate(prevDay.getDate() - 1);
            const prevDayValue = prevDay.toISOString().split('T')[0];

            switch (waktuDinasValue[0]) {
                case 'P':
                    startDatetime = `${prevDayValue} 19:00:00`;
                    endDatetime = `${dateValue} 01:00:00`;
                    break;
                case 'S':
                    startDatetime = `${dateValue} 01:00:00`;
                    endDatetime = `${dateValue} 07:00:00`;
                    break;
                case 'M':
                    startDatetime = `${dateValue} 07:00:00`;
                    endDatetime = `${dateValue} 13:00:00`;
                    break;
                case 'D':
                    startDatetime = `${prevDayValue} 13:00:00`;
                    endDatetime = `${prevDayValue} 19:00:00`;
                    break;
            }

            datetimeQcPrevStart.value = startDatetime;
            datetimeQcPrevEnd.value = endDatetime;
            datetimeQcStart.value = startDatetime;
            datetimeQcEnd.value = endDatetime;
        }

        dateInput.addEventListener('change', updateDatetime);
        waktuDinasSelect.addEventListener('change', updateDatetime);
        updateDatetime()

        function updateDatetimeQcPrevStart() {
            const dateValue = dateInput.value;
            const waktuDinasValue = waktuDinasSelect.value;
            qcIdInput.value = dateValue + "-" + waktuDinasValue;
        }
    });

    // Handle form validation errors
    document.addEventListener('DOMContentLoaded', function () {
        const formErrors = document.getElementById('form-errors');
        if (formErrors && formErrors.dataset.errors === 'true') {
            // Get the error modal element
            const errorModalElement = document.getElementById('errorModal');
            if (errorModalElement) {
                // Initialize the Bootstrap 5 modal
                const errorModal = new bootstrap.Modal(errorModalElement, {
                    backdrop: true, // Enable backdrop click to close
                    keyboard: true  // Enable ESC key to close
                });

                const errorContent = document.getElementById('errorModalContent');

                if (errorContent) {
                    let errorHtml = '<p>Silakan perbaiki kesalahan berikut:</p><ul class="mb-0">';

                    // Get all error elements
                    const errorElements = formErrors.querySelectorAll('[data-field][data-error]');
                    if (errorElements.length > 0) {
                        errorElements.forEach(el => {
                            const fieldId = el.dataset.field;
                            const errorMsg = el.dataset.error;
                            const fieldLabel = document.querySelector(`label[for="${fieldId}"]`);
                            const labelText = fieldLabel ? fieldLabel.textContent.trim().replace(':', '') : fieldId;
                            errorHtml += `<li><strong>${labelText}:</strong> ${errorMsg}</li>`;
                        });
                    } else {
                        // Fallback if no specific field errors found
                        errorHtml += '<li>Terjadi kesalahan saat memproses formulir.</li>';
                    }

                    errorHtml += '</ul>';
                    errorContent.innerHTML = errorHtml;

                    // Show the modal
                    errorModal.show();

                    // Manually handle close button click
                    const closeButtons = errorModalElement.querySelectorAll('[data-bs-dismiss="modal"]');
                    closeButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            errorModal.hide();
                        });
                    });
                }
            }
        }
    });

    // Set NIP's value based on the selected operator
    document.addEventListener('DOMContentLoaded', function () {
        const operatorSelect = document.getElementById('{{ form.operator.id_for_label }}');
        const nipInput = document.getElementById('{{ form.NIP.id_for_label }}');

        function updateNip() {
            const selectedOperator = operatorSelect.value;
            const selectedOperatorText = operatorSelect.options[operatorSelect.selectedIndex].text;

            // Only proceed if an operator is actually selected (not the default empty option)
            if (!selectedOperator) {
                nipInput.value = '';
                return;
            }

            fetch(`/qcfm/api/get_nip/${selectedOperator}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.nip) {
                        nipInput.value = data.nip;
                    } else {
                        nipInput.value = '';
                        // Show modal for empty NIP
                        const emptyNipModal = new bootstrap.Modal(document.getElementById('emptyNipModal'));
                        const modalBody = document.getElementById('emptyNipModalBody');
                        modalBody.innerHTML = `
                            <p>Operator <strong>${selectedOperatorText}</strong> belum memiliki NIP yang terdaftar.</p>
                            <p>Silakan tambahkan NIP melalui halaman <a href="{% url 'core:operator_list' %}" class="alert-link">Manajemen Operator</a>.</p>
                        `;
                        emptyNipModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching NIP:', error);
                    // Don't show error modal for initial page load with no selection
                    if (operatorSelect.value) {
                        showErrorModal('Gagal mengambil data NIP: ' + (error.message || 'Terjadi kesalahan'));
                    }
                });
        }

        operatorSelect.addEventListener('change', updateNip);

        // Only call updateNip on page load if an operator is already selected
        if (operatorSelect.value) {
            updateNip();
        }
    });

    // --- Kelompok Sebelumnya logic ---
    document.addEventListener('DOMContentLoaded', function () {
        // Adjust these IDs if needed
        const shiftSelect = document.getElementById('id_shift');
        const kelompokSelect = document.getElementById('id_kelompok');
        const kelSebelumSelect = document.getElementById('id_kel_sebelum');

        function updateKelSebelum() {
            const shift = shiftSelect.value;
            const kelompok = kelompokSelect.value;
            let newValue = kelompok;
            if (shift === 'Siang' || shift === 'Dini Hari') {
                newValue = kelompok;
            } else {
                // Map kelompok to kel_sebelum based on pattern
                const map = { '1': '4', '2': '5', '3': '1', '4': '2', '5': '3' };
                newValue = map[kelompok] || kelompok;
            }
            // Set kelSebelumSelect value if option exists
            for (let i = 0; i < kelSebelumSelect.options.length; i++) {
                if (kelSebelumSelect.options[i].value === newValue) {
                    kelSebelumSelect.selectedIndex = i;
                    break;
                }
            }
        }
        if (shiftSelect && kelompokSelect && kelSebelumSelect) {
            shiftSelect.addEventListener('change', updateKelSebelum);
            kelompokSelect.addEventListener('change', updateKelSebelum);
            // Call once on page load
            updateKelSebelum();
        }
    });
</script>
{% endblock %}