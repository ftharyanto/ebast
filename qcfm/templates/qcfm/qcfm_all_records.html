{% extends 'core/base.html' %}
{% load static %}

{% block title %}QCFM Records{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="page-header">QCFM Records</h1>
    <div class="container-fluid mt-3">
        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div class="d-flex flex-wrap align-items-center w-100 w-md-auto gap-2">
                    <!-- Export and Search controls -->
                    <div class="input-group input-group-sm me-2" style="min-width: 250px;">
                        <button id="export-csv" class="btn btn-sm btn-success text-light me-2" title="Export to CSV">
                            <i class="fas fa-file-csv me-1"></i> Export All to CSV
                        </button>
                        <button id="export-selected-excel" class="btn btn-sm btn-success text-light me-2" title="Export to Excel">
                            <i class="fas fa-file-excel me-1"></i> Export Selected to Excel
                        </button>
                        <button id="export-selected-pdf" class="btn btn-sm btn-danger text-light me-2" title="Export to PDF">
                            <i class="fas fa-file-pdf me-1"></i> Export Selected to PDF
                        </button>
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="globalSearch" class="form-control" placeholder="Search in all columns...">
                        <button id="clearSearch" class="btn btn-outline-secondary" type="button" title="Clear search" style="border-color: #dee2e6;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column" style="height: calc(100vh - 200px);">
                <div style="flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column;">
                    <div id="tabulator-table" style="flex: 1; min-height: 0; min-width: 100%;"></div>
                </div>
        </div>
    </div>
</div>

<!-- Initialize Tabulator -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Tabulator...');
    
    // Function to perform global search
    function performGlobalSearch() {
        var searchValue = document.getElementById('globalSearch').value.toLowerCase();
        
        if (searchValue === '') {
            table.clearFilter();
            return;
        }
        
        // Create a filter function that checks all string fields
        table.setFilter(function(data) {
            // Check each property of the row
            for (var key in data) {
                // Skip internal Tabulator fields and functions
                if (typeof data[key] === 'function' || key === 'id' || key === '_row' || key === 'table') {
                    continue;
                }
                
                // Get the value and convert to string
                var value = data[key];
                if (value === null || value === undefined) {
                    continue;
                }
                
                // Convert to string and check if it contains the search term
                var stringValue = String(value).toLowerCase();
                if (stringValue.includes(searchValue)) {
                    return true;
                }
            }
            return false;
        });
    }
    
    // Add event listeners for search
    document.addEventListener('DOMContentLoaded', function() {
        var searchInput = document.getElementById('globalSearch');
        var clearSearchBtn = document.getElementById('clearSearch');
        var searchTimeout;
        
        // Search on input with debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performGlobalSearch, 300);
        });
        
        // Clear search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            table.clearFilter();
        });
        
        // Search on Enter key
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                performGlobalSearch();
            } else if (e.key === 'Escape') {
                searchInput.value = '';
                table.clearFilter();
            }
        });
    });
    
    // Function to update status bar and pagination
    function updateStatusBar() {
        const dataCount = table.getDataCount('active');
        const totalCount = table.getDataCount();
        const pageSize = table.getPageSize();
        const pageMax = table.getPageMax();
        const currentPage = table.getPage();
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, dataCount);
        const selectedCount = table.getSelectedRows().length;
        
        // Update pagination info
        document.getElementById('showing-start').textContent = start.toLocaleString();
        document.getElementById('showing-end').textContent = end.toLocaleString();
        document.getElementById('total-entries').textContent = dataCount.toLocaleString();
        
        // Update selected count
        const selectedEl = document.getElementById('selected-count');
        if (selectedCount > 0) {
            selectedEl.textContent = selectedCount.toLocaleString();
            document.getElementById('selected-info').classList.remove('d-none');
        } else {
            document.getElementById('selected-info').classList.add('d-none');
        }
        
        // Show filtered info if data is filtered
        const filteredInfoEl = document.getElementById('filtered-info');
        if (dataCount !== totalCount) {
            document.getElementById('total-unfiltered').textContent = totalCount.toLocaleString();
            filteredInfoEl.classList.remove('d-none');
        } else {
            filteredInfoEl.classList.add('d-none');
        }
        
        // Update pagination button states
        document.getElementById('first-page').disabled = currentPage === 1;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage >= pageMax;
        document.getElementById('last-page').disabled = currentPage >= pageMax;
        
        // Update page size selector
        const pageSizeSelect = document.getElementById('page-size');
        if (pageSizeSelect.value !== pageSize.toString()) {
            pageSizeSelect.value = pageSize;
        }
    }
    
    // Add spinner styles
    var spinnerStyle = document.createElement('style');
    spinnerStyle.textContent = `
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
    `;
    document.head.appendChild(spinnerStyle);

    // Initialize Tabulator with horizontal scrolling
    var table = new Tabulator("#tabulator-table", {
        // Enable Tabulator's built-in loader
        dataLoader: true,
        dataLoaderLoading: "<div class='loading-spinner'></div>Sedang memuat data...",
        dataLoaderError: "Gagal memuat data. Silakan coba lagi.",
        // Disable header filters
        headerFilterLiveFilter: false,
        // Update deprecated configuration options
        layout: "fitColumns", // Explicitly set layout
        responsiveLayout: "collapse", // Explicitly set responsive layout
        layout: "fitDataTable",
        responsiveLayout: false,
        pagination: "local",
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100],
        movableColumns: true,
        selectable: true,
        selectableRangeMode: false,
        selectableRows: true,
        selectableRollingSelection: true,
        selectablePersistence: true,
        selectableCheck: function(row) {
            // You can add custom logic here to make rows unselectable
            return true;
        },
        addRowPos: "top",
        history: true,
        paginationCounter: "rows",
        ajaxURL: `{% url 'qcfm:qcfmrecord_list_api' 0 %}`,
        ajaxConfig: "GET",
        ajaxContentType: "json",
        ajaxResponse: function(url, params, response) {
            console.log('AJAX Response received. Record count:', response ? response.length : 0);
            if (response && response.length > 0) {
                console.log('First record:', response[0]);
            }
            return response;
        },
        ajaxError: function(xhr, status, error) {
            console.error('AJAX Error:', status, error);
            console.error('Response text:', xhr.responseText);
            return [];
        },
        dataLoaded: function(data) {
            console.log('Data loaded into Tabulator. Row count:', data.length);
            if (data.length > 0) {
                console.log('First row data:', data[0]);
            }
            updateStatusBar();
        },
        dataLoadError: function(error) {
            console.error('Data load error:', error);
        },
        tableBuilt: function() {

            const table = this;
            
            // Pagination event handlers
            document.getElementById('first-page').addEventListener('click', () => table.setPage(1));
            document.getElementById('prev-page').addEventListener('click', () => table.previousPage());
            document.getElementById('next-page').addEventListener('click', () => table.nextPage());
            document.getElementById('last-page').addEventListener('click', () => table.setPage('last'));
            
            // Page size change handler
            document.getElementById('page-size').addEventListener('change', function() {
                table.setPageSize(parseInt(this.value));
                table.setPage(1);
            });
            
            // Update status when data changes
            table.on([
                'pageLoaded',
                'pageSizeChanged',
                'dataFiltered',
                'dataSorted',
                'rowSelectionChanged'
            ], updateStatusBar);
            
            // Selection controls
            document.getElementById('select-all').addEventListener('click', () => {
                table.selectRow();
                updateStatusBar();
            });
            
            document.getElementById('deselect-all').addEventListener('click', () => {
                table.deselectRow();
                updateStatusBar();
            });
            
            document.getElementById('select-invert').addEventListener('click', () => {
                const rows = table.getRows();
                rows.forEach(row => row.toggleSelect());
                updateStatusBar();
            });
            
            // Update status when selection changes
            table.on('rowSelectionChanged', updateStatusBar);
            
            // Initial status update
            updateStatusBar();
            const tableElement = document.querySelector('.tabulator-tableholder');
            const scrollLeftBtn = document.getElementById('scroll-left');
            const scrollRightBtn = document.getElementById('scroll-right');
            
            // Update button states
            const updateButtonStates = () => {
                scrollLeftBtn.disabled = tableElement.scrollLeft === 0;
                scrollRightBtn.disabled = tableElement.scrollLeft >= (tableElement.scrollWidth - tableElement.clientWidth - 5);
            };
            
            // Scroll left
            scrollLeftBtn.addEventListener('click', () => {
                tableElement.scrollBy({ left: -200, behavior: 'smooth' });
                setTimeout(updateButtonStates, 300);
            });
            
            // Scroll right
            scrollRightBtn.addEventListener('click', () => {
                tableElement.scrollBy({ left: 200, behavior: 'smooth' });
                setTimeout(updateButtonStates, 300);
            });
            
            // Update on scroll
            tableElement.addEventListener('scroll', updateButtonStates);
            
            // Initial state
            updateButtonStates();
        },
        columns: [
            // Row selection column
            {
                title: "",
                field: "select",
                headerSort: false,
                resizable: false,
                width: 40,
                formatter: "rowSelection",
                titleFormatter: "rowSelection",
                hozAlign: "center",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.getRow().toggleSelect();
                }
            },
            { title: "ID", field: "id", width: 80, hozAlign: "right" },
            { 
                title: "QCFM ID", 
                field: "qcfm_id", 
                width: 180,
                formatter: function(cell, formatterParams, onRendered) {
                    const value = cell.getValue();
                    return value || '';
                }
            },
            { 
                title: "Date", 
                field: "date", 
                width: 120, 
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.substring(0, 10) : '';
                }
            },
            { 
                title: "Jam Pelaksanaan", 
                field: "jam_pelaksanaan", 
                width: 150,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Shift", 
                field: "shift", 
                width: 100,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "Kelompok", 
                field: "kelompok", 
                width: 100,
                hozAlign: "center"
            },
            { 
                title: "Kel Sebelum", 
                field: "kel_sebelum", 
                width: 120,
                hozAlign: "center"
            },
            { 
                title: "Operator", 
                field: "operator", 
                width: 200,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "NIP", 
                field: "NIP", 
                width: 150,
                formatter: function(cell) {
                    return cell.getValue() || '';
                }
            },
            { 
                title: "QC Sebelumnya", 
                field: "qc_prev", 
                width: 120,
                hozAlign: "center",
                formatter: function(cell) {
                    return '<span style="color: #0d6efd; cursor: pointer;" class="view-qcfm" data-field="qcfm_prev">View</span>';
                },
                cellClick: function(e, cell) {
                    const data = cell.getRow().getData();
                    const modalBody = document.getElementById('qcfmModalBody');
                    if (modalBody) {
                        modalBody.textContent = data.qcfm_prev || 'No data available';
                        const modal = new bootstrap.Modal(document.getElementById('qcfmModal'));
                        modal.show();
                    }
                }
            },
            { 
                title: "QC FM", 
                field: "qcfm", 
                width: 80,
                hozAlign: "center",
                formatter: function(cell) {
                    return '<span style="color: #0d6efd; cursor: pointer;" class="view-qcfm" data-field="qcfm">View</span>';
                },
                cellClick: function(e, cell) {
                    const data = cell.getRow().getData();
                    const modalBody = document.getElementById('qcfmModalBody');
                    if (modalBody) {
                        modalBody.textContent = data.qcfm || 'No data available';
                        const modal = new bootstrap.Modal(document.getElementById('qcfmModal'));
                        modal.show();
                    }
                }
            }
        ]
    });


    // Clear selection when clicking outside the table
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#tabulator-table')) {
            table.deselectRow();
        }
    });

    // Global search functionality
    document.getElementById('globalSearch').addEventListener('input', function(e) {
        const searchValue = e.target.value.toLowerCase();
        table.setFilter(function(data) {
            // Search in all fields except date
            const match = [
                'qcfm_id', 'jam_pelaksanaan', 'shift', 'kelompok', 'kel_sebelum',
                'operator', 'NIP', 'qcfm', 'qcfm_prev'
            ].some(field => {
                const value = data[field];
                return value !== null && value !== undefined && 
                       value.toString().toLowerCase().includes(searchValue);
            });

            // Search in date field
            if (!match && data.date) {
                return new Date(data.date).toISOString().includes(searchValue);
            }

            return match;
        });
    });

    // Clear search button
    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('globalSearch').value = '';
        table.clearFilter();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search with Ctrl+F or Cmd+F
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('globalSearch').focus();
            document.getElementById('globalSearch').select();
        }
        // Clear search with Escape
        else if (e.key === 'Escape' && document.activeElement === document.getElementById('globalSearch')) {
            e.preventDefault();
            document.getElementById('globalSearch').value = '';
            table.clearFilter();
        }
    });

    // Export to CSV button click handler
    document.getElementById('export-csv').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        
        try {
            // Make a fetch request to the export endpoint
            const response = await fetch('/qcfm/api/export-csv/');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get the blob data
            const blob = await response.blob();
            
            // Create a temporary URL for the blob
            const url = window.URL.createObjectURL(blob);
            
            // Create a temporary link and trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = 'qcfm_records_export.csv';
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Show success message
            showSuccessModal('Export completed successfully!');
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });

    // Export Selected to Excel button click handler
    document.getElementById('export-selected-excel').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exporting...';

        try {
            // Get selected rows
            const selectedRows = table.getSelectedRows();
            if (selectedRows.length === 0) {
                showErrorModal('Please select at least one record to export.');
                return;
            } else if (selectedRows.length > 5) {
                showErrorModal('You can only export up to 5 records at a time. Please select fewer records.');
                return;
            }

            // Update button text to show progress
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting 0/${selectedRows.length}...`;
            
            // Process each selected record
            for (let i = 0; i < selectedRows.length; i++) {
                const row = selectedRows[i];
                const recordId = row.getData().id;
                
                try {
                    // Update progress
                    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting ${i + 1}/${selectedRows.length}...`;
                    
                    // Make a fetch request for each record
                    const response = await fetch(`/qcfm/api/export-to-excel/${recordId}/`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for record ${recordId}`);
                    }
                    
                    // Get the blob data and filename from the response
                    const blob = await response.blob();
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/['"]+/g, '');
                    
                    // Create a temporary URL for the blob
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger the download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `qcfm_record_${recordId}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Small delay between downloads to avoid overwhelming the browser
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error exporting record ${recordId}:`, error);
                    // Continue with next record even if one fails
                    continue;
                }
            }
            
            // Show completion message
            showSuccessModal(`Successfully exported ${selectedRows.length} record(s)`);
            
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }); 

    // Export Selected to PDF button click handler
    document.getElementById('export-selected-pdf').addEventListener('click', async function() {
        // Show loading state
        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        
        try {
            // Get selected records from the table
            const selectedRows = table.getSelectedRows();
            
            if (selectedRows.length === 0) {
                showErrorModal('Please select at least one record to export');
                button.disabled = false;
                button.innerHTML = originalText;
                return;
            } else if (selectedRows.length > 5) {
                showErrorModal('You can only export up to 5 records at a time. Please select fewer records.');
                button.disabled = false;
                button.innerHTML = originalText;
                return;
            }
    
            // Update button text to show progress
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting 0/${selectedRows.length}...`;
            
            // Process each selected record
            for (let i = 0; i < selectedRows.length; i++) {
                const row = selectedRows[i];
                const recordId = row.getData().id;
                
                try {
                    // Update progress
                    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> Exporting ${i + 1}/${selectedRows.length}...`;
                    
                    // Make a fetch request for each record
                    const response = await fetch(`/qcfm/api/export-to-pdf/${recordId}/`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for record ${recordId}`);
                    }
                    
                    // Get the blob data and filename from the response
                    const blob = await response.blob();
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/['"]+/g, '');
                    
                    // Create a temporary URL for the blob
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger the download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `qcfm_record_${recordId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Small delay between downloads to avoid overwhelming the browser
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error exporting record ${recordId}:`, error);
                    // Continue with next record even if one fails
                    continue;
                }
            }
            
            // Show completion message
            showSuccessModal(`Successfully exported ${selectedRows.length} record(s)`);
            
        } catch (error) {
            console.error('Export failed:', error);
            showErrorModal('Export failed: ' + error.message);
        } finally {
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }); 

    // Function to show error modal
    function showErrorModal(message) {
        const errorContent = document.getElementById('errorModalContent');
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        
        if (errorContent) {
            errorContent.textContent = message;
            errorModal.show();
        } else {
            // Fallback to alert if modal not found
            console.error('Error modal not found. Message:', message);
            alert(message);
        }
    }
    
    // Function to show success modal
    function showSuccessModal(message) {
        const successContent = document.getElementById('successModalContent');
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        
        if (successContent) {
            successContent.textContent = message;
            successModal.show();
        } else {
            // Fallback to alert if modal not found
            console.log('Success modal not found. Message:', message);
            alert(message);
        }
    }
});
</script>

<!-- QCFM Modal -->
<div class="modal fade" id="qcfmModal" tabindex="-1" aria-labelledby="qcfmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qcfmModalLabel">QC FM</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="qcfmModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
